setoid(20000000);

PROC mmn() : BAT[oid,str] {
	 return(monet_mod_nme.kdiff(monet_mod_nme.[startsWith]("_").uselect(true)));
}

loaded();
mmn().reverse().mark(oid(nil)).sort().print();
view_modules().reverse().mark(oid(nil)).kunique().sort().print();

loaded();
mmn().reverse().mark(oid(nil)).sort().print();

# # module("Meta");
# # loaded();
# # mmn().reverse().mark(oid(nil)).sort().print();

var fix:=mmn().reverse().copy();
fix.mark(oid(nil)).print();

# skip pftijah & xrpc_server as they require pathfinder to be loaded first
var others:=kdiff(view_modules().reverse().kunique(),mmn().reverse()).access(BAT_WRITE).delete("pftijah").delete("xrpc_server").sort().access(BAT_WRITE).revert();
others.mark(oid(nil)).print();

others@batloop(){
	printf("\n\tloading %s\n\n",$h);
	module($h);
	loaded();
	var off:=kdiff(mmn().reverse(),fix);
	off.mark(oid(nil)).print();
	off@batloop(){
		printf("\n\tdropping %s\n\n",$h);
	}
	drop($h);
	loaded();
}
quit();
