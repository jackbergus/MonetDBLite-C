var k1 := new(void,int,1000);
var i := 0;
while(i < 1000) {
        k1.insert(nil,i);
        i :+= 1;
}

var m1 := new(void,int,1000000);
i := 0;
while(i < 1000) {
        m1.insert(k1);
        i :+= 1;
}
m1.seqbase(0@0);

dir("tmp");

i := 0;
mem_maxsize(lng(10*1024*1024));
#vm_maxsize(lng(100*1024*1024));
while(i < 10) {
        #mem_usage(100000).print();
	print("DIR");
	dir("b_");
        #vm_usage(100000).print();
        print("COPY");
        var b := m1.copy().rename(sprintf("b_%d",i :+= 1));
        b.persists(true).commit();
}

proc countall (..any..) : void {
  var i := 0;
  while(i < $0) {
     i :+= 1;
     $(i).count().print();
  }
}

dir("b_");

countall(bat("b_1"),bat("b_2"),bat("b_3"),bat("b_4"));

dir("b_");

quit();
