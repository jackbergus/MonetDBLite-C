PROC check_cap(BAT _b) : void {
	VAR inserted := count(_b);
	VAR deleted := count(delta(_b));
	VAR cap := capacity(_b);
	VAR overflow := (inserted + deleted) - cap;
	IF (overflow > lng(0)) {
		printf("!ERROR: wrote %d BUNs beyond capacity\n",overflow);
	}
}

VAR b := new(oid,oid);
b.rename("b");
b.persists(true);

VAR cap := int(capacity(b) / 4) + 1;

VAR i := cap * 3;
WHILE (i > 0) {
	b.insert(oid(i),oid(i));
	i := i - 1;
}

commit();

i := cap * 2;
WHILE (i > 0) {
        b.delete(oid(i));
        i := i - 1;
}

VAR c := new(oid,oid);
i := cap * 2;
WHILE (i > 0) {
	c.insert(oid(i),oid(i));
	i := i - 1;
}

b := b.insert(c);
check_cap(b);

b.persists(false);

commit();

quit();
