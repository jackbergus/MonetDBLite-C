@echo off

if not "%1"=="" goto skip
call %0 -rq
goto :EOF

:skip

setlocal

set pkg=geom
set buildbase=@XBUILD@
set srcdir=@XSOURCE@

REM enable auto-loading of modules before `make install`
if not exist "%buildbase%\sql\backends\monet5\autoload" mkdir "%buildbase%\sql\backends\monet5\autoload"
copy /y "%srcdir%"\sql\backends\monet5\??_*.mal "%buildbase%\sql\backends\monet5\autoload"
rem vaults is not (yet?) built on Windows
rem if not exist "%buildbase%\sql\backends\monet5\vaults\autoload" mkdir "%buildbase%\sql\backends\monet5\vaults\autoload"
rem copy /y "%srcdir%"\sql\backends\monet5\vaults\??_*.mal "%buildbase%\sql\backends\monet5\vaults\autoload"
rem if "@HAVE_MSEED_FALSE@"==""	del /y "%buildbase%\sql\backends\monet5\vaults\autoload\71_mseed.mal"
rem if "@HAVE_CFITSIO_FALSE@"==""	del /y "%buildbase%\sql\backends\monet5\vaults\autoload\72_fits.mal"

REM enable auto-loading of SQL createdb scripts before `make install`
if not exist "%buildbase%\sql\sql\createdb" mkdir "%buildbase%\sql\sql\createdb"
copy /y "%srcdir%"\sql\sql\??_*.sql "%buildbase%\sql\sql\createdb"
if "@HAVE_RAPTOR_FALSE@"==""	del /y "%buildbase%\sql\sql\createdb\30_rdf.sql"

copy /y "%srcdir%"\geom\monetdb5\??_*.mal "%buildbase%\sql\backends\monet5\autoload"
copy /y "%srcdir%"\geom\sql\??_*.sql "%buildbase%\sql\sql\createdb"

rem binaries (.exe)
set PATH=%buildbase%\clients\examples\C;%PATH%
set PATH=%buildbase%\clients\mapiclient;%PATH%
set PATH=%buildbase%\clients\odbc\samples;%PATH%
set PATH=%buildbase%\testing;%PATH%
set PATH=%buildbase%\tools\mserver;%PATH%

rem libraries (.dll)
set PATH=%buildbase%\clients\mapilib;%PATH%
set PATH=%buildbase%\clients\perl\Cimpl;%PATH%
set PATH=%buildbase%\common\stream;%PATH%
set PATH=%buildbase%\gdk;%PATH%
set PATH=%buildbase%\monetdb5\tools;%PATH%

rem modules (lib_*.dll and *.mal)
set MOD_PATH=%buildbase%\geom\monetdb5
set MOD_PATH=%buildbase%\monetdb5\extras\compiler;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\extras\crackers;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\modules\atoms;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\modules\kernel;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\modules\mal;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\optimizer;%MOD_PATH%
set MOD_PATH=%buildbase%\monetdb5\scheduler;%MOD_PATH%
rem vaults is not (yet?) built on Windows
rem set MOD_PATH=%buildbase%\sql\backends\monet5\vaults;%MOD_PATH%
set MOD_PATH=%buildbase%\sql\backends\monet5;%MOD_PATH%
set MOD_PATH=%buildbase%\sql\sql;%MOD_PATH%

set PYTHONPATH=%buildbase%\clients\python\build\lib;%buildbase%\testing;%srcdir%\testing;%PYTHONPATH%

set CLASSPATH=%buildbase%\java;%buildbase%\java\tests;%CLASSPATH%

set perlib=%buildbase%\clients\perl;%srcdir%\clients\perl
set PERLLIB=%perlib%;%PERLLIB%
set PERL5LIB=%perlib%;%PERL5LIB%

rem execute Mtest.py in the source directory
pushd "%srcdir%"

call "%buildbase%\testing\Mtest.py" "--package=%pkg%" "--monet_mod_path=%MOD_PATH%" "--dbfarm=%buildbase%\%pkg%\dbfarm" "--TSTTRGBASE=%buildbase%\%pkg%" %1 %2 %3 %4 %5 %6 %7 %8 %9
if ERRORLEVEL 1 exit %ERRORLEVEL%

popd
endlocal
