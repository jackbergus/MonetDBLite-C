@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

rem if both M4 & M5 are available, M5 is default;
rem otherwise, the available one is default
if "@HAVE_MONETDB4_FALSE@" == "#" set V=4
if "@HAVE_MONETDB5_FALSE@" == "#" set V=5
rem commandline option overrules default
if "%1" == "-4" set V=4& shift
if "%1" == "-5" set V=5& shift

set pkg=geom
set buildbase=@XBUILD@
set builddir=%buildbase%\geom
set srcdir=@XSOURCE@\geom

set MOD_PATH=%builddir%\monetdb%V%\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\monetdb%V%

REM enable auto-loading of modules before `make install`
if not exist %builddir%\monetdb%V%\autoload mkdir %builddir%\monetdb%V%\autoload
copy /y %srcdir%\monetdb%V%\??_*.mal %builddir%\monetdb%V%\autoload

REM enable auto-loading of SQL createdb scripts before `make install`
set MOD_PATH=%MOD_PATH%;%builddir%\sql
if not exist %builddir%\sql\createdb mkdir %builddir%\sql\createdb
copy /y %srcdir%\sql\??_*.sql %builddir%\sql\createdb

if not %V% == 4 goto skip_4
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\plain\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\plain
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\contrib\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\contrib
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\calibrator\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\calibrator
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mapi\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mapi
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mnetcdf\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mnetcdf
set MOD_PATH=%MOD_PATH%;%srcdir%\..\monetdb4\scripts\tools

set PATH=%buildbase%\monetdb4\tools;%PATH%
set cfg=%buildbase%\monetdb4\conf\MonetDB.conf
:skip_4

if not %V% == 5 goto skip_5
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\vaults\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\vaults
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\sql

REM enable auto-loading of modules before `make install`
if not exist %buildbase%\sql\backends\monet5\autoload mkdir %buildbase%\sql\backends\monet5\autoload
copy /y %srcdir%\..\sql\backends\monet5\??_*.mal %buildbase%\sql\backends\monet5\autoload
if not exist %buildbase%\sql\backends\monet5\vaults\autoload mkdir %buildbase%\sql\backends\monet5\vaults\autoload
copy /y %srcdir%\..\sql\backends\monet5\vaults\??_*.mal %buildbase%\sql\backends\monet5\vaults\autoload

REM enable auto-loading of SQL createdb scripts before `make install`
if not exist %buildbase%\sql\sql\createdb mkdir %buildbase%\sql\sql\createdb
copy /y %srcdir%\..\sql\sql\??_*.sql %buildbase%\sql\sql\createdb

set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\optimizer\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\optimizer
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\scheduler\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\scheduler
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\atoms\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\atoms
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\kernel\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\kernel
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\mal\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\mal
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\crackers\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\crackers
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\rdf\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\rdf
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\xml\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\xml

REM enable auto-loading of modules before `make install`
if not exist %buildbase%\monetdb5\extras\rdf\autoload mkdir %buildbase%\monetdb5\extras\rdf\autoload
copy /y %srcdir%\..\monetdb5\extras\rdf\??_*.mal %buildbase%\monetdb5\extras\rdf\autoload
if not exist %buildbase%\monetdb5\extras\xml\autoload mkdir %buildbase%\monetdb5\extras\xml\autoload
copy /y %srcdir%\..\monetdb5\extras\xml\??_*.mal %buildbase%\monetdb5\extras\xml\autoload

set PATH=%buildbase%\tools\mserver;%PATH%
set cfg=%buildbase%\monetdb5\misc\monetdb5.conf
:skip_5

set PATH=%buildbase%\clients\mapiclient;%buildbase%\clients\examples\C;%buildbase%\clients\perl\Tests;%buildbase%\testing;%PATH%

set PATH=%MOD_PATH%;%PATH%

rem to find geos_c.dll
set PATH=%GEOS%\bin;%PATH%

set PYTHONPATH=%buildbase%\clients\python\build\lib;%buildbase%\testing;%srcdir%\..\testing;%PYTHONPATH%

set CLASSPATH=%buildbase%\java;%buildbase%\java\tests;%CLASSPATH%

set perlib=%buildbase%\clients\perl;%srcdir%\..\clients\perl
set PERLLIB=%perlib%;%PERLLIB%
set PERL5LIB=%perlib%;%PERL5LIB%

REM execute Mtest.py in the source directory
pushd %srcdir%

call "%buildbase%\testing\Mtest.py" "--config=%cfg%" -%V% "--package=%pkg%" "--monet_mod_path=%MOD_PATH%" "--dbfarm=%builddir%\dbfarm" "--TSTTRGBASE=%builddir%" %1 %2 %3 %4 %5 %6 %7 %8 %9

popd
endlocal

:end
