@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

rem if both M4 & M5 are available, M5 is default;
rem otherwise, the available one is default
if "@HAVE_MONETDB4_FALSE@" == "#" set V=4
if "@HAVE_MONETDB5_FALSE@" == "#" set V=5
rem commandline option overrules default
if "%1" == "-4" set V=4& shift
if "%1" == "-5" set V=5& shift

set monetdb4_prefix=@XMONETDB4_PREFIX@
set monetdb5_prefix=@XMONETDB5_PREFIX@

if %V% == 4 call "%monetdb4_prefix%\bin\monetdb4-config.bat" --internal
if %V% == 5 call "%monetdb5_prefix%\bin\monetdb5-config.bat" --internal

REM ... remainder is not working/correct, yet ...

set prefix=@MONETDB_PREFIX@
set builddir=@XMONETDB_BUILD@
set srcdir=@XMONETDB_SOURCE@

set MOD_PATH=%prefix%\src\modules\plain\.libs;%prefix%\src\modules\plain;%prefix%\src\modules\contrib\.libs;%prefix%\src\modules\contrib;%prefix%\src\modules\calibrator\.libs;%prefix%\src\modules\calibrator;%prefix%\src\modules\mnetcdf\.libs;%prefix%\src\modules\mnetcdf;%prefix%\src\mapi\.libs;%prefix%\src\mapi

rem to find the geom module
set MOD_PATH=%builddir%\src\.libs;%MOD_PATH%

set PATH=%prefix%\src\testing;%prefix%\src\tools;%prefix%\src\mapi\clients\C;%prefix%\src\mapi\clients\python;%PATH%
set PYTHONPATH=%prefix%\src\testing;%srcdir%\src\testing;%prefix%\src\common;%srcdir%\src\mapi\clients\python
set PATH=%MOD_PATH%;%prefix%\src\common;%prefix%\src\gdk;%prefix%\src\mapi\clients\C;%prefix%\src\modules\plain\stream;%prefix%\src\monet;%PATH%

rem to find geos_c.dll
set PATH=%builddir%;%PATH%

REM execute Mtest.py in the source directory
pushd %srcdir%

call python "Mtest.py" "--TSTSRCBASE=%srcdir%" "--TSTBLDBASE=%builddir%" "--TSTTRGBASE=%builddir%" "--monet_mod_path=%MOD_PATH%" "--config=%prefix%\conf\MonetDB.conf" "--dbfarm=%prefix%\dbfarm" "--sql_logdir=%prefix%\log" %*

popd
endlocal

:end
