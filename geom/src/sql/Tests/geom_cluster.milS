module(geom);
module("unix");
module(ascii_io);

#var dataDir := environment().find("monet_cwd");
var dataDir := getenv("TSTSRCBASE") + "/data";
var minX := flt(-180), minY := flt(-90), maxX := flt(180), maxY := flt(90);

#####
# geom_point
#####
VAR datafile := dataDir + "/geom_cluster.data.aerofacp_trans_point.ascii";
VAR len := -1;
VAR namebat := bat(void, str); namebat.seqbase(0@0);
VAR typebat := bat(void, str); typebat.seqbase(0@0);
VAR sepbat := bat(void, str); sepbat.seqbase(0@0);

namebat.append("id");
typebat.append("int");
sepbat.append(",");

namebat.append("f_code");
typebat.append("str");
sepbat.append(",");

namebat.append("iko");
typebat.append("str");
sepbat.append(",");

namebat.append("nam");
typebat.append("str");
sepbat.append(",");

namebat.append("na3");
typebat.append("str");
sepbat.append(",");

namebat.append("use");
typebat.append("int");
sepbat.append(",");

namebat.append("zv3");
typebat.append("int");
sepbat.append(",");

namebat.append("tile_id");
typebat.append("int");
sepbat.append(",");

namebat.append("end_id");
typebat.append("int");
sepbat.append(",");

namebat.append("point");
typebat.append("geom_wkb");
sepbat.append("\n");

VAR aerofacp_trans_point := load(namebat, sepbat, typebat, datafile, len);

var geoms := aerofacp_trans_point.find("point");
var count := geoms.count();

var cluster := geom_cluster("points", geoms, geom_mbr(minX, minY, maxX, maxY));

print(cluster);
print(count);
print(cluster.oids().count());
print(cluster.filters().count());
print(cluster.geoms().count());
print(cluster.oids().slice(count - 10, count - 1), cluster.filters().slice(count - 10, count - 1), cluster.geoms().slice(count - 10, count - 1));

#####
# geom_linestring
#####
VAR datafile := dataDir + "/geom_cluster.data.dqline_util_line.ascii";
VAR len := -1;
VAR namebat := bat(void, str); namebat.seqbase(0@0);
VAR typebat := bat(void, str); typebat.seqbase(0@0);
VAR sepbat := bat(void, str); sepbat.seqbase(0@0);

namebat.append("id");
typebat.append("int");
sepbat.append(",");

namebat.append("dqdescr_id");
typebat.append("int");
sepbat.append(",");

namebat.append("feature_class");
typebat.append("str");
sepbat.append(",");

namebat.append("f_code");
typebat.append("str");
sepbat.append(",");

namebat.append("tile_id");
typebat.append("int");
sepbat.append(",");

namebat.append("edg_id");
typebat.append("int");
sepbat.append(",");

namebat.append("line");
typebat.append("geom_wkb");
sepbat.append("\n");

VAR dqline_util_line := load(namebat, sepbat, typebat, datafile, len);

var geoms := dqline_util_line.find("line");
var count := geoms.count();

var cluster := geom_cluster("lines", geoms, geom_mbr(minX, minY, maxX, maxY));

print(cluster);
print(count);
print(cluster.oids().count());
print(cluster.filters().count());
print(cluster.geoms().count());
print(cluster.oids().slice(count - 10, count - 1), cluster.filters().slice(count - 10, count - 1), cluster.geoms().slice(count - 10, count - 1));

#####
# geom_polygon
#####
VAR datafile := dataDir + "/geom_cluster.data.landicea_phys_area.ascii";
VAR len := -1;
VAR namebat := bat(void, str); namebat.seqbase(0@0);
VAR typebat := bat(void, str); typebat.seqbase(0@0);
VAR sepbat := bat(void, str); sepbat.seqbase(0@0);

namebat.append("id");
typebat.append("int");
sepbat.append(",");

namebat.append("f_code");
typebat.append("str");
sepbat.append(",");

namebat.append("tile_id");
typebat.append("int");
sepbat.append(",");

namebat.append("fac_id");
typebat.append("int");
sepbat.append(",");

namebat.append("area");
typebat.append("geom_wkb");
sepbat.append("\n");

VAR landicea_phys_area := load(namebat, sepbat, typebat, datafile, len);

var geoms := landicea_phys_area.find("area");
var count := geoms.count();

var cluster := geom_cluster("areas", geoms, geom_mbr(minX, minY, maxX, maxY));

print(cluster);
print(count);
print(cluster.oids().count());
print(cluster.filters().count());
print(cluster.geoms().count());
print(cluster.oids().slice(count - 10, count - 1), cluster.filters().slice(count - 10, count - 1), cluster.geoms().slice(count - 10, count - 1));
