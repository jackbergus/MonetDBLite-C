# First test of the remoteQueries optimizer
# we create a remote bat and fake a bind operation.

cat:= inspect.getEnvironment();
fs := algebra.find(cat,"mapi_port");
port := calc.int(fs);
#io.printf("port %d\n",port);

mid:= mserver.reconnect("s0_0","localhost",port,"monetdb","monetdb","mal");
mserver.rpc(mid,"rb:= bat.new(:int,:int); bat.setName(rb,\"rbat\");");
mserver.rpc(mid,"bat.insert(rb,1,1);");
mserver.rpc(mid,"bat.insert(rb,3,3);");
mserver.rpc(mid,"bat.insert(rb,5,5);");
mserver.rpc(mid,"bat.insert(rb,6,6);");
mserver.rpc(mid,"bat.insert(rb,7,7);");
mserver.rpc(mid,"c:=algebra.select(rb,0,12);");
c:bat[:int,:int]:= mserver.rpc(mid, "io.print(c);");
io.print(c);
mserver.rpc(mid,"c:=algebra.select(rb,0,4);");
c:bat[:int,:int]:= mserver.rpc(mid, "io.print(c);");
io.print(c);

b:bat[:int,:int]:= mserver.bind(mid,"rbat");
io.print(b);

# see if we can do some remote selections.
mserver.rpc(mid,"d:=algebra.select(b,5,10);");
low:= 5+1;
mserver.put(mid,"low",low);
mserver.rpc(mid,"e:=algebra.select(d,low,7);");
mserver.rpc(mid,"i:=aggr.count(d);");
i:lng:= mserver.rpc(mid,"io.print(i);");
io.printf(" count %d\n",i);
d:bat[:int,:int]:= mserver.rpc(mid,"io.print(d);");
io.print(d);
optimizer.remoteQueries();
