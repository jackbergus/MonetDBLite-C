#!/bin/bash
# The contents of this file are subject to the MonetDB Public License
# Version 1.1 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
# http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
# License for the specific language governing rights and limitations
# under the License.
#
# The Original Code is the MonetDB Database System.
#
# The Initial Developer of the Original Code is CWI.
# Portions created by CWI are Copyright (C) 1997-2005 CWI.
# All Rights Reserved.

function usage()
{
	echo "Usage: monetdb [command] [options] [script]"
	echo "Primary command:"
	echo "    --start         Server(s) are started in the dbfarm"
	echo "    --stop          Server(s) are gracefully stopped"
	echo "    --status        Show the server status"
	echo "    --checkpoint    Create a database checkpoint"
	echo "    --log           Show the server management log"
	echo ""
	echo "Secondary options:"
	echo "    --dbname=<database_name>"
	echo "    --dbfarm=<directory>"
	echo "    --dbinit=<stmt>           Server prepare statement"
	echo "    --config=<config_file>    Configuration file"
	echo "    --debug=<number>          Trace server actions[0]"
	echo "    --daemon=yes|no           Run in background [no]"
	echo "    --set <option>=<value>    Set environment value"
	echo "    --help                    This list of options"
}

DBFARM=$MONET5_PREFIX/var/MonetDB5/dbfarm
ACTION="--start"

case "$1" in
 "--start" | "--stop" | "--status" | "--checkpoint" ) 
		ACTION=$1;
		shift
		ARGS=$* ;;
 "--log" )
		cd $DBFARM
		more monetdb.log
		exit
		;;
 "--help" )
	usage 
	exit ;;
 * ) ;;
esac

function getPID ()
{
	active=""
	if [ -f $1/.gdk_lock ]
	then
		pid=`head -1 $1/.gdk_lock |sed -e "s/.*PID=//"|sed -e "s/ .*//"`
		active=`ps --no-heading --format pid -p $pid`
	fi
	echo $active
}

function getTIME ()
{
	head -1 $1/.gdk_lock | sed -e "s/.*TIME=//"| sed -e "s/\@.*//"
}

function start_mserver()
{
	pid=`getPID $1`
	#echo "start server $1 $pid"
	if [ $pid"" = "" ]
	then
		# use previous arguments if needed
		args=$ARGS
		if [ $ARGS"" = "--dbname=$1" ]
		then
			if [ -f $1/.mserver.args ]
			then
				args=`cat $1/.mserver.args`
			fi
			mserver --set daemon=yes --dbname=$1 $args &
		else
			mserver --set daemon=yes --dbname=$1 $args &
		fi
		echo $args > $1/.mserver.args
		sleep 2
		pid=`getPID $1`
		if [ $pid"" = "" ]
		then
			echo `date +"%F %T"` " FAILED $1 $args" >>monetdb.log
		else
			echo `date +"%F %T"` " START $1 $args" >>monetdb.log
		fi
		# start the guardian for this server as well
		mguardian --delay=300 --dbname=$1
	else
		echo "$1 server already running"
	fi
}
function stop_mserver()
{
	pid=`getPID $1`
	if [ $pid"" != "" ]
	then
		# disable the guardian first
		mguardian --stop $1
		kill -TERM $pid
		echo `date +"%F %T"` " STOP  $1" >>monetdb.log
	fi
}

function show_status_hdr()
{
	echo "DBNAME	PID	GUARD	STARTED				STATUS"
}
function show_status()
{
	if [ -f $1/.gdk_lock ]
	then
		if [ -f $1/.mguardian ]
		then
			guard=`cat $1/.mguardian`
		fi
		if [ -f $1/.mserver.status ]
		then
			status=$status`cat $1/.mserver.status`
		fi

		pid=`getPID $1`
		if  [ $pid"" != "" ]
		then
			start=`getTIME $1`
			echo "$1	$pid	$guard	$start			$status"
		fi
	fi
}

# switch to dbfarm
cd $DBFARM
DBLIST=`ls`

# check for an overruling database name
tmp=`echo $* | sed -e "s/^.*--dbname=//"|sed -e "s/ .*//"`
if [ "$tmp" != "" ]
then
	if [ ! -d $tmp ]
	then
		#echo "create the database directory"
		mkdir $tmp
	fi
	DBLIST=$tmp
fi
#echo "DBLIST $DBLIST"

case "$ACTION" in
 "--start" )
	for i in $DBLIST
	do
		if [ -d $i ]
		then
			start_mserver  $i 
		fi
	done
	;;
 "--stop" )
	for i in $DBLIST
	do
		if [ -d $i ]
		then
			stop_mserver  $i 
		fi
	done
	;;
 "--status" )
	show_status_hdr
	for i in $DBLIST
	do
		if [ -d $i ]
		then
			show_status  $i 
		fi
	done
	;;
 "--checkpoint" ) 
	echo "Not yet implemented" ;;
 * ) ;;
esac
