# Testing bpm.fold, bpm.new, and bpm.addPartition

function gen(n:sht):bat[:oid,:sht];
	r:=bat.new(:oid,:sht);
	barrier (go,i):=language.newRange(0:sht);
                bat.append(r,i);
                redo (go,i):= language.nextElement(1:sht,n);
        exit (go,i);
	return r;
end gen;

n:=bpm.new(:oid,:sht);

r1:=gen(200:sht);
bpm.addPartition(n,r1);
io.print("dump r1");
bpm.dump(n);

r2:=gen(200:sht);
bpm.addPartition(n,r2);
io.print("dump r2");
bpm.dump(n);

r3:=gen(200:sht);
bpm.addPartition(n,r3);
io.print("dump r3");
bpm.dump(n);

r4:=gen(200:sht);
bpm.addPartition(n,r4);
io.print("dump 4");
bpm.dump(n);

barrier g:= bpm.newIterator(n);
	i:= aggr.count(g);
	io.printf("cnt %d\n",i);
redo g:= bpm.hasMoreElements(n);
exit g;

