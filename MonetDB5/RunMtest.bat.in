@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

set pkg=monetdb5
set buildbase=@XBUILD@
set builddir=%buildbase%\monetdb5
set srcdir=@XSOURCE@\monetdb5

set MOD_PATH=%builddir%\optimizer\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\optimizer
set MOD_PATH=%MOD_PATH%;%builddir%\scheduler\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\scheduler
set MOD_PATH=%MOD_PATH%;%builddir%\modules\atoms\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\modules\atoms
set MOD_PATH=%MOD_PATH%;%builddir%\modules\kernel\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\modules\kernel
set MOD_PATH=%MOD_PATH%;%builddir%\modules\mal\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\modules\mal
set MOD_PATH=%MOD_PATH%;%builddir%\extras\crackers\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\extras\crackers
set MOD_PATH=%MOD_PATH%;%builddir%\extras\rdf\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\extras\rdf
set MOD_PATH=%MOD_PATH%;%builddir%\extras\xml\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\extras\xml

REM enable auto-loading of modules before `make install`
if not exist %builddir%\extras\rdf\autoload mkdir %builddir%\extras\rdf\autoload
copy /y %srcdir%\extras\rdf\??_*.mal %builddir%\extras\rdf\autoload
if not exist %builddir%\extras\xml\autoload mkdir %builddir%\extras\xml\autoload
copy /y %srcdir%\extras\xml\??_*.mal %builddir%\extras\xml\autoload

set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\vaults\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\backends\monet5\vaults
set MOD_PATH=%MOD_PATH%;%buildbase%\sql\sql

REM enable auto-loading of modules before `make install`
if not exist %buildbase%\sql\backends\monet5\autoload mkdir %buildbase%\sql\backends\monet5\autoload
copy /y %srcdir%\backends\monet5\??_*.mal %buildbase%\sql\backends\monet5\autoload
if not exist %buildbase%\sql\backends\monet5\vaults\autoload mkdir %buildbase%\sql\backends\monet5\vaults\autoload
copy /y %srcdir%\backends\monet5\vaults\??_*.mal %buildbase%\sql\backends\monet5\vaults\autoload
if "@HAVE_MSEED_FALSE@"==""	del /y %buildbase%\sql\backends\monet5\vaults\autoload\71_mseed.mal
if "@HAVE_CFITSIO_FALSE@"==""	del /y %buildbase%\sql\backends\monet5\vaults\autoload\72_fits.mal

set MOD_PATH=%MOD_PATH%;%buildbase%\geom\monetdb5\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\geom\monetdb5

set PATH=%buildbase%\clients\mapiclient;%buildbase%\clients\examples\C;%buildbase%\clients\examples\php;%buildbase%\clients\examples\python;%buildbase%\clients\perl\Tests;%buildbase%\testing;%PATH%

set PATH=%MOD_PATH%;%PATH%
set PATH=%builddir%\mal;%PATH%
set PATH=%buildbase%\tools\mserver;%PATH%

set PYTHONPATH=%buildbase%\clients\python\build\lib;%buildbase%\testing;%srcdir%\..\testing;%PYTHONPATH%

set CLASSPATH=%buildbase%\java;%buildbase%\java\tests;%CLASSPATH%

set perlib=%buildbase%\clients\perl;%srcdir%\..\clients\perl
set PERLLIB=%perlib%;%PERLLIB%
set PERL5LIB=%perlib%;%PERL5LIB%

REM execute Mtest.py in the source directory
pushd %srcdir%

call "%buildbase%\testing\Mtest.py" --package=%pkg% "--monet_mod_path=%MOD_PATH%" "--dbfarm=%builddir%\dbfarm" "--TSTTRGBASE=%builddir%" %*

popd
endlocal

:end
