#test the basics of the recycler
# testing toll-based retention

module sql;
function sql.mvc():int;
    return mvc:=1;
end mvc;

function sql.tid(mvc:int,s:str,t:str):bat[:oid,:oid];
b:= bat.new(:oid,:oid);
barrier i:= 0:oid;
    bat.append(b,i);
    redo i:= iterator.next(1:oid,11:oid);
exit i;
    return tid:= b;
end tid;

function sql.bind(mvc:int, s:str,t:str,c:str,i:int):bat[:oid,:int];
    b:= bat.new(:oid,:int);
    bat.insert(b,0@0,0);
    bat.insert(b,1@0,1);
    bat.insert(b,2@0,2);
    bat.insert(b,3@0,3);
    bat.insert(b,4@0,4);
    bat.insert(b,5@0,5);
    bat.insert(b,6@0,6);
    bat.insert(b,7@0,7);
    bat.insert(b,8@0,8);
    bat.insert(b,9@0,9);
    bat.insert(b,10@0,10);
    bat.insert(b,11@0,11);
    return bind:=b;
end bind;

function qry(low:int, hgh:int);
    m:= sql.mvc();
    x:bat[:oid,:oid]  := sql.tid(m,"sys","tbl");
    b:bat[:oid,:int]:= user.bind(m,"sys","tbl","col",0);
    s:= algebra.subselect(b,x,low,hgh,true,true,false);
	(j1,j2):= algebra.join(s,b);
end qry;

#inter-query commonality
function qry1(val:int);
    m:= sql.mvc();
    x:bat[:oid,:oid]  := sql.tid(m,"sys","tbl");
    b:bat[:oid,:int]:= user.bind(m,"sys","tbl","col",0);
    s:= algebra.subselect(b,x,val,val,true,true,false);
	j1:= algebra.join(s,b);
    io.print(j1);
end qry1;

recycle.setAdmPolicy(3);
recycle.setReusePolicy(1);
recycle.setCachePolicy(1,5);
optimizer.recycler("user","qry");
optimizer.recycler("user","qry1");

qry1(2);
qry1(5);
qry1(7);

# selection is not reused: it is added maximum (MAX_INTEREST-Min_INTEREST = 3) number of times
recycle.dump();
io.print("3 select instances");

#the following call does not add the select to RP, its tolls are finished
qry1(10);
recycle.dump();
io.print("still 3 select instances, tolls are finished");

#new execution can still re-use some of the existing instances in the RP
qry1(5);
recycle.dump();
io.print("reuse of instruction #2 even when tolls are finished");

#next call evicts all instructions from qry1 returning the tolls to the
#reused ones
qry(1,5);
recycle.dump();
io.print("all instructions from qry1 evicted");

# new call adds the instructions with tolls back to RP
qry1(10);
recycle.dump();
io.print("qry1 reused instructions added again");
