# groups of related archs
%define all_x86 i386 i586 i686

%ifarch %{all_x86}
%define bits 32
%else
%define bits 64
%endif

%define name MonetDB5-server
%define version @VERSION@
%define release 1%{?dist}%{?oid32:.oid32}%{!?oid32:.oid%{bits}}

%define prefix /usr
%define sysconfdir /etc
%define localstatedir /var/lib

Name: %{name}
Version: %{version}
Release: %{release}
Summary: MonetDB - Monet Database Management System
Group: System
Source: MonetDB5-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-root
Packager: Niels Nes <Niels.Nes@cwi.nl>
License:   MPL - http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
BuildRequires: python

%{!?_with_python: %{!?_without_python: %define _with_python --with-python}}
%{!?buildsystem: %define buildsystem 0}
%define builddoc 0

Requires: MonetDB-client >= 1.19
#                           ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%if !%{?buildsystem}
BuildRequires: MonetDB-devel >= 1.19
#                               ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
BuildRequires: MonetDB-client-devel >= 1.19
#                                      ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%endif
PreReq: /sbin/chkconfig, /sbin/service, sh-utils
PreReq: %{_sbindir}/groupadd, %{_sbindir}/useradd

%package devel
Summary: MonetDB development package
Group: System
Requires: %{name} = %{version}-%{release}
Requires: MonetDB-devel
Requires: MonetDB-client-devel

%description
MonetDB is a database management system that is developed from a
main-memory perspective with use of a fully decomposed storage model,
automatic index management, extensibility of data types and search
accellerators, SQL- and XML- frontends.

This package contains the MonetDB5 server component.

%description devel
MonetDB is a database management system that is developed from a
main-memory perspective with use of a fully decomposed storage model,
automatic index management, extensibility of data types and search
accellerators, SQL- and XML- frontends.

This package contains the files that are needed to develop for and
with MonetDB5.

%prep
rm -rf $RPM_BUILD_ROOT

%setup -q -n MonetDB5-%{version}

%build

./configure \
	--enable-assert=no \
	--enable-optimize \
	--enable-bits=%{bits} \
	%{?oid32:--enable-oid32} \
	%{?comp_cc:CC="%{comp_cc}"} \
	--prefix=%{prefix} \
	--sysconfdir=%{sysconfdir} \
	--localstatedir=%{localstatedir} \
	--libdir=%{_libdir}

make

%install
rm -rf $RPM_BUILD_ROOT

make install \
	DESTDIR=$RPM_BUILD_ROOT

mkdir -p $RPM_BUILD_ROOT/%{localstatedir}/MonetDB5
# insert example db here!

find $RPM_BUILD_ROOT -name .incs.in -print -o -name \*.la -print | xargs rm -f

# cleanup stuff we don't want to install
rm -rf $RPM_BUILD_ROOT%{_libdir}/MonetDB5/Tests/*
rm -rf $RPM_BUILD_ROOT%{prefix}/bin/monetdb5-config.bat

# Fixes monet config script
#perl -p -i -e "s|$RPM_BUILD_ROOT||" $RPM_BUILD_ROOT%{prefix}/bin/monet_config

%clean
rm -fr $RPM_BUILD_ROOT

%files
%defattr(-,root,root)
%{prefix}/bin/mserver5
%{prefix}/bin/Mbeddedmal
%{prefix}/bin/mchkpnt
%{prefix}/bin/merovingian
%{prefix}/bin/monetdb
%{prefix}/bin/mrecover
%{prefix}/bin/stethoscope

%{_libdir}/*.so.*
%{_libdir}/MonetDB5/lib/*.so*
%{_libdir}/MonetDB5/*.mal

%attr(770,monetdb,monetdb) %dir %{localstatedir}/MonetDB5

%config(noreplace) %{sysconfdir}/monetdb5.conf

%files devel
%defattr(-,root,root)
%{prefix}/bin/monetdb5-config
%{prefix}/include/MonetDB5/*.h
%{prefix}/include/MonetDB5/*/*.[hcm]
%{_libdir}/*.so


%pre
%{_sbindir}/groupadd -r monetdb 2>/dev/null || :
%{_sbindir}/useradd -d %{localstatedir}/MonetDB5 -s /bin/true -g monetdb -M -r monetdb 2>/dev/null || :

%post
umask 022

#create monetdb init script
#/sbin/chkconfig --add monetdb

%changelog
* Mon Jun 25 2007 Sjoerd Mullender <sjoerd@acm.org> - @VERSION@-1
- Built.

