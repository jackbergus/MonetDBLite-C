<html lang="en">
<head>
<title>Factory definitions - Untitled</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Untitled">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="MonetDB-Assembler-Language.html#MonetDB-Assembler-Language" title="MonetDB Assembler Language">
<link rel="prev" href="Commands-and-Patterns.html#Commands-and-Patterns" title="Commands and Patterns">
<link rel="next" href="Type-resolution.html#Type-resolution" title="Type resolution">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This file documents the MonetDB Version 5.0 Reference Manual

Last updated: June 5, 2006

     Copyright (C) 2000-2006 CWI

     Permission is granted to make and distribute verbatim
     copies of this manual provided the copyright notice and
     this permission notice are preserved on all copies.-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
body { 
    margin: 0px;
    padding: 0px;
}
a,a:visited {
	color: #336633;
}
a:hover {
	color: #003300;
}

p,body {
    font-family: Verdana, Arial, Helvetica, sans-serif;
    text-align: justify;
    font-size: 10pt;
}

h1 {
    font-family: Verdana, Arial, Helvetica, sans-serif;
    font-size: 14pt;
    font-style: bold;
	text-align: left;
}

td,th {
    font-family: Verdana, Arial, Helvetica, sans-serif;
    font-size: 10pt;
}

div.banner {
	padding: 5px 0px 0px 5px; 
}

div.banner img {
	border: 0px;
	text-decoration: none;
}

div.topmenu {
	margin-top: -20px;
	margin-left: 166px;
	padding: 8px 5px 5px 5px;
	font-size: 8pt;
	background-color: #A9CC99;
}

div.topmenu-bottom {
	margin-top: -4px;
	margin-left: 166px;
	padding: 2px 5px;
	background-color: #BCD2ED; 
}

div.topmenu a {
	padding: 4px 5px 1px 5px;
	text-decoration: none; 
}

div.topmenu a:focus {
	background-color: #6699CC; 
}

div.topmenu a:hover {
	background-color: #5662A0; 
}

/*
span.current {
}
*/

div.topmenu span.current a {
	color: #000000;
	background-color: #BCD2ED; 
}

/* this should be inherited IMHO, but it doesn't so we just redefine it */
div.topmenu span.current a:hover {
	color: #336633;
	background-color: #BCD2ED; 
}

/*
span.submenu {
}
*/

div.topmenu span.submenu a {
	background-color: #CBEEBB;
}

/* this should be inherited IMHO, but it doesn't so we just redefine it */
div.topmenu span.submenu a:hover {
	background-color: #9FB0DB; 
}

div.topmenu span.button {
	margin: 0px 0px 0px 10px;
}

div.topmenu span.button a {
	padding: 5px 6px 1px 6px;
	color: #333333;
	background-color: #FFAC37;
}

div.topmenu span.button a:hover {
	color: #FFFFFF;
}

div.content {
	padding: 5px;
	margin-left: 166px;
	margin-right: 12%;
}

div.header {
	padding: 5px;
	margin-left: 166px;
	margin-right: 12%;
}


div.sidebar-a {
	float: left;
	width: 156px;
	padding: 5px;
	font-size: 8pt;
}

div.sidebar-b { 
	float: right;
	width: 146px;
	margin: 0px 0px 0px 5px;
	padding: 5px;
	font-size: 8pt;
}

div.footer-a {
	float: left;
	width: 156px;
	margin: 5px 0px 0px 0px;
	padding: 5px;
	font-size: 7pt;
	background-color: #CBEEBB;
}

div.footer-a a {
	margin: 5px;
	text-decoration: none; 
}

div.footer-b {
	margin: 5px 0px 0px 0px;
	padding: 5px;
	background-color: #A9CC99;
	font-size: 7pt;
}

div.footer-b a {
	margin: 5px;
	padding: 2px 3px;
	text-decoration: none; 
}
div.footer-b a:focus {
	background-color: #6699CC; 
}
div.footer-b a:hover {
	color: #FFFFFF;
	background-color: #5662A0; 
}
div.footer-b img {
	border: 0px;
	vertical-align: bottom;
	text-decoration: none; 
}

div.news {
	border: 1px solid #666699;
	background-color: #E7E7E7; 
	margin: 3px 0px;
	padding: 5px 5px 5px 5px;
}

div.news li {
	list-style: square;
}

div.submenu-b {
	border: 1px solid #666699;
	background-color: #CBEEBB;
	margin: 3px 0px;
	padding: 5px 5px 5px 5px;
}

div.submenu-b a {
	text-decoration: none; 
	display: block;
	padding: 1px 2px;
	color: #000000;
	background-color: #A9CC99;
}

div.submenu-b a:hover {
	background-color: #BCD2ED; 
}

div.submenu-b ul {
	padding: 1px 0px 1px 0px;
	margin: 0px;
}

div.submenu-b li {
	list-style: none;
	padding: 1px 0px 0px 6px;
}

div.submenu {
	border: 1px solid #666699;
	background-color: #9FB0DB; 
	margin: 3px 0px;
	padding: 5px 5px 5px 5px;
}

div.submenu a {
	text-decoration: none; 
	display: block;
	padding: 1px 2px;
	_width: 100%;
}

div.submenu ul {
	padding: 1px 0px 1px 0px;
	margin: 0px;
}

div.submenu li {
	list-style: none;
	padding: 1px 0px 0px 6px;
}

div.submenu span.submenu a {
	color: #000000;
	background-color: #BCD2ED; 
}

/* this should be inherited IMHO, but it doesn't so we just redefine it */
div.submenu span.submenu a:hover {
	background-color: #A9CC99;
}

div.submenu span.current a {
	background-color: #CBEEBB;
}

/* this should be inherited IMHO, but it doesn't so we just redefine it */
div.submenu span.current a:hover {
	background-color: #CBEEBB;
}

pre.code {
	border: 1px solid Black;
	padding: 4px;
	font-family: monospace;
}
.authors {
	font-size: smaller;
	font-style: italic;
}
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Factory-definitions"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="Type-resolution.html#Type-resolution">Type resolution</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Commands-and-Patterns.html#Commands-and-Patterns">Commands and Patterns</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="MonetDB-Assembler-Language.html#MonetDB-Assembler-Language">MonetDB Assembler Language</a>
<hr>
</div>

<h3 class="section">7.4 Factories</h3>

<p>A convenient programming construct is the co-routine, which
is specified as an ordinary function, but maintains its
own state between calls, and permits re-entry other than
by the first statement.

   <p>The random generator example is used to illustrate its definition and use.
<pre class="example">     factory random(seed:int,limit:int):int;
         rnd:=seed;
         lim:= limit;
     barrier lim;
         leave lim:= lim-1;
         rnd:= rnd*125;
         yield rnd:= rnd % 32676;
         redo lim;
     exit lim;
     end random;
</pre>
   <p>The first time this factory is called, a factory plant
is created in the local system to handle the requests. 
The plant carries the stack frame and synchronizes access.

   <p>In this case it initializes the generator. 
The random number is generated and <code>yield</code>  as
a result of the call. The factory process is then put to sleep. 
The second call received by the factory wakes it up at the
point where it went to sleep. In this case it will
find a <code>redo</code> statement and produces the next random number. 
Note that also in this case a seed and limit value are
expected, but they are ignored in the body. 
This factory can be called upon to generate at most 'limit'
random numbers using the 'seed' to initialize the generator. 
Thereafter it is being removed, i.e. reset to the original state.

   <p>A cooperative group of factories can be readily constructed. 
For example, assume we would like the
random factories to respond to both <code>random(seed,limit)</code>
and <code>random()</code>. This can be defined as follows:
<pre class="example">     factory random(seed:int,limit:int):int;
         rnd:=seed;
         lim:= limit;
     barrier lim;
         leave lim:= lim-1;
         rnd:= rnd*125;
         yield rnd:= rnd % 32676;
         redo lim;
     exit lim;
     end random;
     
     factory random():int;
     barrier forever:=true;
         yield random(0,0);
         redo forever;
     exit forever;
     end random;
</pre>
   <h4 class="subsection">7.4.1 Client support</h4>

<p>For simple cases, e.g. implementation of a random function,
it suffices to ensure that the state is secured between calls. 
But, in a database context there are multiple clients
active. This means we have to be more precise on the relationship
between a co-routine and the client for which it works.

   <p>The co-routine concept researched in Monet 5 is the notion of a 'factory',
which consists of 'factory plants' at possibly different locations and
with different policies to handle client requests. 
Factory management is limited to its owner, which is derived from the module
in which it is placed. By default Admin is the owner of all modules.

   <p>The factory produces elements for multiple clients. 
Sharing the factory state or even remote processing is
up to the factory owner. 
They are set through properties for the factory plant.

   <p>The default policy is to instantiate one shared
plant for each factory. If necessary, the factory
can keep track of a client list to differentiate
the states. 
A possible implementation would be:
<pre class="example">     factory random(seed:int,clientid:int):int;
         clt:= bat.new(:int,:int);
         bat.insert(clt,clientid,seed);
     barrier always:=true;
         rnd:= algebra.find(clt,clientid);
     catch   rnd; #failed to find client
         insert(clt,clientid,seed);
         rnd:= algebra.find(clt,clientid);
     exit    rnd;
         rnd:= rnd * 125;
         rnd:= rnd % 32676;
         algebra.replace(clt,clientid,rnd);
         yield rnd;
         redo always;
     exit always;
     end random;
</pre>
   <p>The operators to built client aware factories are,
<code>factory.getCaller()</code>, which returns a client
index, <code>factory.getModule()</code> and <code>factory.getFunction()</code>,
which returns the identity of scope enclosed.

   <p>To illustrate, the client specific random generator
can be shielded using the factory:
<pre class="example">     factory random(seed:int):int;
     barrier always:=true;
         clientid:= factory.getCaller();
         yield user.random(seed, clientid);
         redo always;
     exit always;
     end random;
</pre>
   <h4 class="subsection">7.4.2 Complex factory examples</h4>

<p>One interesting use of the factory scheme is to model
a volcano-style query processor. Each node in the query
tree is an iterator that calls upon the operands to produce
a chunk, which are combined into a new  chunk for concumption
of the parent. The prototypical join(R,S) query illustrates it. 
The plan does not test for all boundary conditions, it merely
implements a nested loop. The end of a sequence is identified
by a NIL chunk.

<pre class="example">     factory query();
         Left:= sql.bind("relationA");
         Right:= sql.bind("relationB");
         rc:= sql.joinStep(Left,Right);
     barrier rc!= nil;
         io.print(rc);
         rc:= sql.joinStep(Left,Right);
         redo rc!= nil;
     exit rc;
     end query;
     
     #nested loop join
     factory sql.joinStep(Left:bat[:any,:any],Right:bat[:any,:any]):bat[:any,:any];
         lc:= chopper.chunkStep(Left);
     barrier outer:= lc != nil;
         rc:= chopper.chunkStep(Right);
         barrier inner:= rc != nil;
             chunk:= algebra.join(lc,rc);
             yield chunk;
             rc:= chopper.chunkStep(Right);
             redo inner:= rc != nil;
         exit inner;
         lc:= chopper.chunkStep(Left);
         redo outer:= lc != nil;
     exit outer;
         # we have seen everything
         return nil;
     end joinStep;
     
     #factory for left branch
     factory chunkStepL(L:bat[:any,:any]):bat[:any,:any];
         i:= 0;
         j:= 20;
         cnt:= algebra.count(L);
     barrier outer:= j&lt;cnt;
         chunk:= algebra.slice(L,i,j);
         i:= j;
         j:= i+ 20;
         yield chunk;
         redo loop:= j&lt;cnt;
     exit outer;
         # send last portion
         chunk:= algebra.slice(L,i,cnt);
         yielD chunk;
         return nil;
     end chunkStep;
     
     #factory for right leg
     factory chunkStepR(L:bat[:any,:any]):bat[:any,:any];
</pre>
   <p>So far we haven;t re-used the pattern that both legs are
identical. This could be modeled by a generic chunk factory. 
Choosing a new factory for each query steps reduces the
administrative overhead.

   <p>The Factory concept is still rather experimental and many
questions should be considered, e.g. 
What is the lifetime of a factory? Does it persists after
all clients has disappeared? 
What additional control do you need? Can you throw an
exception to a Factory?

<pre class="example"></pre>
   </body></html>

