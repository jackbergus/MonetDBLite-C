#!/bin/bash

echo "create bdy files"

if [ -z "$3" ];
then
	echo "usage $0 subtarget m5prefix m4prefix" > /dev/stderr
	exit -1
fi

# extract the texi files from the source trees
# leave them behind in a temporary directory

MANUAL=$1
dir=$2
m4dir=$3

mkdir ${dir}/doc/share/tmp/${MANUAL}
cd ${dir}/src/mal
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}

cd ${dir}/src/optimizer
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}

cd ${m4dir}/src/gdk
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}
cp *pdf ${dir}/doc/share/tmp/${MANUAL}
cp *feps *pdf ${dir}/doc/share/tmp/${MANUAL}
sed -i -e "/@t/,/@contents/d" ${dir}/doc/share/tmp/${MANUAL}/gdk.bdy.texi

cd ${m4dir}/src/mapi/clients/C
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}

cd ${dir}/src/modules/mal
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		cp $b.bdy.texi ${dir}/doc/share/tmp/${MANUAL}/$b.bdy.texi.bak
		ex $b.bdy.texi <<!EOF
		/^@example/s/.*/ @table @code/
/^@end example/s//@end table/
		g/^command/s//@item command
		g/^pattern/s//@item pattern
		g/^function/s//@item function
		g/^address/d
		g/^comment "/s///
		g/^comment/s///
		g/{unsafe}/s//@{unsafe@}/
		g/";/s///
		/^@example/,/^@end example/d
		/^@example/,/^module/-1d
		/@table/+1s/module \(.*\);/ @noindent module @code{\1};/
/@tabl/m/@tabl/+1
		0i
@page
.
		f
		w!
!EOF
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}
cd ${dir}/src/mil
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}
cd ${dir}/src/modules/atoms
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
cp *gif *eps *pdf ${dir}/doc/share/tmp/${MANUAL}
cd ${dir}/src/modules/kernel
for f in  `ls *.mx`
do
	b=`basename $f .mx`
	echo "---->" $f $b.bdy.texi 
        Mx -i -B -H1 $f
		mv $b.bdy.texi  ${dir}/doc/share/tmp/${MANUAL}
done
