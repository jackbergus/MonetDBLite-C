%define name MonetDB
%define version @VERSION@
%define release 1_@LINUX_DIST@.oid@oids@

%define prefix /usr
%define sysconfdir /etc
%define localstatedir /var/lib

%define monetdb_uid    85
%define monetdb_gid    85

Name: %{name}
Version: %{version}
Release: %{release}
Summary: MonetDB - Monet Database Management System
Group: System
Source: %{name}-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-root
Packager: Niels Nes <Niels.Nes@cwi.nl>
License:   MPL - http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
BuildRequires: python 

%{!?_with_php: %{!?_without_php: %define _with_php --with-php}}
%{!?_with_python: %{!?_without_python: %define _with_python --with-python}}
%{!?_with_perl: %{!?_without_perl: %define _with_perl --with-perl}}
%{!?_with_java: %{!?_without_java: %define _with_java --with-java}}
%{!?buildsystem: %define buildsystem 0}
%define comp_cc @CC@
%define builddoc 0

# groups of related archs
%define all_x86 i386 i586 i686

%ifarch %{all_x86}
%define bits 32
%else
%define bits 64
%endif

%package client
Summary: MonetDB clients
Group: System

%if %{?_with_php:1}%{!?_with_php:0}
%package php
Summary: MonetDB php interface
Group: System
%if !%{?buildsystem}
BuildRequires: php 
%endif
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%package python
Summary: MonetDB python interface
Group: System
%if !%{?buildsystem}
BuildRequires: python swig
%endif
%endif

%if %{?_with_perl:1}%{!?_with_perl:0}
%package perl
Summary: MonetDB perl interface
Group: System
%if !%{?buildsystem}
BuildRequires: perl swig 
%endif
%endif

%if %{?_with_java:1}%{!?_with_java:0}
%package java
Summary: MonetDB java interface
Group: System
%if !%{?buildsystem}
BuildRequires: ant java 
%endif
%endif

%package server
Summary: MonetDB server 
Group: System 

%package devel
Summary: MonetDB development package 
Group: System 

%if %{builddoc}
%package docu
Summary: MonetDB documentation
Group: System 
%endif

%description
MonetDB is a database management system that is developed from a
main-memory perspective with use of a fully decomposed storage model,
automatic index management, extensibility of data types and search
accellerators, SQL- and XML- frontends.

%description client
Add the MonetDB client description here

%if %{?_with_php:1}%{!?_with_php:0}
%description php
Add the MonetDB php description here
Requires: %{name}-client
Requires: php
%define php_extensiondir %(php-config --extension-dir)
%define php_peardir %(pear config-get php_dir | sed -e s+php_dir=++g)
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%description python
Add the MonetDB python description here
Requires: %{name}-client
Requires: python
%define python_libdir %(python -c 'import distutils.sysconfig; print distutils.sysconfig.get_python_lib(1,0,"")')
%endif

%if %{?_with_perl:1}%{!?_with_perl:0}
%description perl
Add the MonetDB perl description here
Requires: %{name}-client
Requires: perl
%define perl_libdir %(perl -MConfig -e '$x=$Config{installvendorarch}; $x =~ s|$Config{vendorprefix}/||; print $x;')
%endif

%if %{?_with_java:1}%{!?_with_java:0}
%description java
Add the MonetDB java description here
Requires: %{name}-client
Requires: java
%endif

%description server
Add the MonetDB server description here
Requires: %{name}-client

%description devel
Add the MonetDB devel description here
Requires: %{name}-server
Requires: epsffit
PreReq: /sbin/chkconfig, /sbin/service, sh-utils
PreReq: %{_sbindir}/groupadd, %{_sbindir}/useradd

%if %{builddoc}
%description docu
Add the MonetDB documentation description here
%endif


%prep
rm -rf $RPM_BUILD_ROOT

%setup -q -n %{name}-%{version}

%build

./configure \
	--enable-assert=no \
	--enable-optimize \
	--enable-bits=%{bits} \
	--with-gcc="%{comp_cc}" \
	--with-gxx="%{comp_cxx}" \
	--prefix=%{prefix} \
	--sysconfdir=%{sysconfdir} \
	--localstatedir=%{localstatedir} \
	--libdir=%{_libdir} \
	%{?_with_php} %{?_without_php} \
	%{?_with_python} %{?_without_python} \
	%{?_with_perl} %{?_without_perl} \
	%{?_with_java} %{?_without_java} 

make

%install
rm -rf $RPM_BUILD_ROOT

make install \
	DESTDIR=$RPM_BUILD_ROOT 

mkdir -p $RPM_BUILD_ROOT/%{localstatedir}/MonetDB/dbfarm
# insert example db here!

find $RPM_BUILD_ROOT -name .incs.in | xargs rm -f

# cleanup stuff we don't want to install
rm -rf $RPM_BUILD_ROOT%{prefix}/bin/epsffit
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/conf/conf.bash
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/general.mil
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/lady.gif
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/docs/*/*.tex
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/docs/*/*/*.tex
rm -rf $RPM_BUILD_ROOT%{prefix}/share/%{name}/Tests/sample.class

# Fixes monet config script
#perl -p -i -e "s|$RPM_BUILD_ROOT||" $RPM_BUILD_ROOT%{prefix}/bin/monet_config

%clean
rm -fr $RPM_BUILD_ROOT

%files client
%defattr(-,monetdb,monetdb) 
%{prefix}/bin/MapiClient* 
%{prefix}/bin/msqldump* 
%{_libdir}/libmutils.*
%{_libdir}/libMapi.* 
%{_libdir}/libstream.*
%{_libdir}/MonetDB/Tests/*
%{prefix}/share/%{name}/python/* 

%config(noreplace) %{sysconfdir}/MonetDB.conf 

%pre client 
%{_sbindir}/groupadd -g %{monetdb_gid} -r monetdb 2>/dev/null || :
%{_sbindir}/useradd -d %{localstatedir}/%{name} -s /bin/true -g monetdb -M -r -u %{monetdb_uid} monetdb 2>/dev/null || :

%if %{?_with_php:1}%{!?_with_php:0}
%files php
%defattr(-,monetdb,monetdb) 
%{php_extensiondir}/*
%{php_peardir}/DB/*
%{prefix}/share/%{name}/php/*
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%files python
%defattr(-,monetdb,monetdb) 
%{prefix}/%{python_libdir}/*
%endif

%if %{?_with_perl:1}%{!?_with_perl:0}
%files perl
%defattr(-,monetdb,monetdb) 
%{prefix}/%{perl_libdir}/*
%{prefix}/share/%{name}/perl/* 
%endif

%if %{?_with_java:1}%{!?_with_java:0}
%files java
%defattr(-,monetdb,monetdb) 
%{prefix}/share/%{name}/lib/*jar
%endif

%files server
%defattr(-,monetdb,monetdb) 
%{prefix}/bin/Mserver 
%{prefix}/bin/Mbeddedmil 

%{_libdir}/libbat.*
%{_libdir}/libmonet.*
%{_libdir}/libembeddedmil.*
%{_libdir}/%{name}/*.so* 
%{_libdir}/%{name}/*.la* 
%{_libdir}/%{name}/*.mil* 

%{prefix}/share/%{name}/tools/* 

%dir %{localstatedir}/%{name}

%files devel
%defattr(-,monetdb,monetdb) 
%{prefix}/bin/monetdb-config*
%{prefix}/share/%{name}/conf/monet.m4 

%{prefix}/bin/calibrator

%{prefix}/share/%{name}/Mprofile-commands.lst 
%{prefix}/share/%{name}/quit.mil 

%{prefix}/bin/prof.py*
%{prefix}/bin/Mtest.py*
%{prefix}/bin/Mapprove.py*
%{prefix}/bin/Mfilter.py*
%{prefix}/bin/Mprofile.py*
%{prefix}/bin/Mlog*
%{prefix}/bin/Mdiff*
%{prefix}/bin/Mtimeout*
%{prefix}/bin/MkillUsers*

%{_libdir}/pkgconfig/MonetDB.pc

%{prefix}/include/%{name}/*.h
%{prefix}/include/%{name}/*/*.[hcm]

%if %{builddoc}
%files docu
%defattr(-,monetdb,monetdb)
%{prefix}/share/%{name}/docs/*/*.html
%{prefix}/share/%{name}/docs/*/*.pdf
%{prefix}/share/%{name}/docs/*/*.ps
%{prefix}/share/%{name}/docs/*/*/*.html
%{prefix}/share/%{name}/docs/*/*/*.pdf
%{prefix}/share/%{name}/docs/*/*/*.ps
%endif

%post server
umask 022

#create monetdb init script
#/sbin/chkconfig --add monetdb

