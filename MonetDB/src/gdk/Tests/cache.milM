module(alarm);

proc test_batcache(int n, int r) : void {
  var b := bat(void,void);
  var j := 0;
  while(j < r) {
    {
      var bb := bat(int,bat,3*n);
      var i := 0;
      while(i < n) {
        var ht := i % 11;
        var tt := (i/11) % 11;
        var v := str(i);
        var vh := b;
        var vt := b;
        if (ht != bat) vh := v.cast(ht);
        if (tt != bat) vt := v.cast(tt);
        var bn := bat(ht,tt).insert(vh, vt).access(BAT_READ);
        var bh := bn.hmark(0@0); # create some views
        var bt := bn.tmark(0@0); # create some views
        bb.insert(i,bn);
        bb.insert(i,bh);
        bb.insert(i,bt);
        i :+= 1;
      }
    }
    # bb destroyed => flush 3*n bats through the cache
    var i := 0;
    while(i < n) {
      var ht := i % 11;
      var tt := (i/11) % 11;
      var v := str(i);
      var vh := b;
      var vt := b;
      if (ht != bat) vh := v.cast(ht);
      if (tt != bat) vt := v.cast(tt);
      var bn := bat(ht,tt).insert(vh, vt).access(BAT_READ);
      var bh := bn.hmark(0@0);
      var bt := bn.tmark(0@0);
      i :+= 1;
    }
    j :+= 1;
  }
}
debugmask(0);
dir("tmp");
test_batcache(100,300);

var t := time();
test_batcache(100,300);
var t1 := time() - t;
dir("tmp");

bbp_batcache_minsize(0LL);
t := time();
test_batcache(100,300);
var t2 := time() - t;
dir("tmp");
print(t1 < t2);
