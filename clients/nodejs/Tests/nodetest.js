var monetdb = require('../monetdb');
var assert = require('assert');

var dbport = parseInt(process.argv[2]);
var dbname = process.argv[3];

/* lets first check some failing connection attempts */
monetdb.connect({host:'veryinvalidhostnamethathopefullyresolvesnowhere'}, function(err) {
	assert(err);
});

monetdb.connect({dbname:'nonexist', port:dbport}, function(err) {
	assert(err);
});

var failedconn = monetdb.connect({dbname:dbname, user:'nonexist', port:dbport}, function(err) {
	assert(err);
});
/* try to query on a failed connection, we need this callback */
failedconn.query('SELECT 1',function(err,res) {
	assert(err);
});

/* now actually connect */
var conn = monetdb.connect({dbname:dbname, port:dbport, debug: false}, function(err) {
	assert.equal(null, err);
	assert.equal(conn.env.gdk_dbname, dbname);
});


/* some querying, call chaining */
conn.query('start transaction').
	query('create table foo(a int, b float, c clob)').
	query("insert into foo values (42,4.2,'42'),(43,4.3,'43'),(44,4.4,'44'),(45,4.5,'45')");

conn.query('select * from foo', function(err, res) {
	assert.equal(null, err);

	assert.equal('table', res.type);
	assert.equal(4, res.rows);
	assert.equal(3, res.cols);

	assert.equal(3, res.structure.length);

	assert.equal('a', res.structure[0].column);
	assert.equal('int', res.structure[0].type);

	assert.equal(4, res.data.length);

	assert.equal(42, res.data[0][res.structure[0].index]);
	assert.equal(4.3, res.data[1][res.col['b']]);
	assert.equal('44', res.data[2][2]);
});

/* we can also just put the queries in one .query call */
conn.query('delete from foo; drop table foo; rollback');

/* query that will stress multi-block operations */
function rep(str,n) {
	ret = '';
	for (var i = 0; i< n; i++) {
		ret += str;
	}
	return ret;
}

var longstr = rep('ABCDEFGHIJKLMNOP', 100000);
conn.query("SELECT '" + longstr + "'", function(err, res) {
	assert.equal(null, err);
	assert.equal(longstr,res.data[0][0]);
});

/* failing query */
conn.query('MEHR BIER', function(err, res) {
	assert(err);
});

/* prepared statements */
conn.query('MEHR BIER',
	['connections', 0, false], function(err, res) {
		assert(err);
}); 


/* fire-and-forget query with parameters */
conn.query('SELECT id from tables where name=? and type=? and temporary=?',
	['connections', 0, 0], function(err, res) {
		assert.equal(null, err);
		assert(res.rows > 0);
}); 

/* Try the log callback functionality */
var nr_log_callbacks = 0;
conn.log_callback = function(message, error, result) {
	assert(message); // message must contain something
	++nr_log_callbacks;
}
conn.query('SELECT id FROM tables WHERE name=? AND type=? AND temporary=?',
	['connections', 0, 0], function(err, res) {
		assert.equal(null, err);
		assert(nr_log_callbacks > 0);
		conn.log_callback = null;	
});

/* some quoting fun, jesus */
conn.query("SELECT '\\\\asdf','\"', '\\\"', '\\\\\"', '\\''", function(err, res) {
	assert.equal(null, err);
	assert.equal('\\asdf', res.data[0][0]);
	assert.equal('"', res.data[0][1]);
	assert.equal('\"', res.data[0][2]);
	assert.equal('\\"', res.data[0][3]);
	assert.equal("'", res.data[0][4]);
});

/* prepared statements can also be re-used  */
conn.prepare('SELECT id from tables where name=? and type=? and temporary=?', function(err, res){
	assert.equal(null, err);

	/* parameters can also be given as array */
	res.exec(['connections', 0, 0], function(err, res) {
		assert.equal(null, err);
		assert(res.rows > 0);
	});

	/* this fails due to missing param */
	res.exec([0, false], function(err, res) {
		assert(err);
	});

	res.release();
});

conn.close();
