stdout of test 'except-union-intersect-bug-sf-1146079` in directory 'src/test/bugs` itself:


# 20:14:43 >  
# 20:14:43 >  Mtimeout -timeout 300 Mserver "--config=/ufs/fabian/scratch/monetdb/current/program-x86_64/etc/MonetDB.conf" --debug=10 --set "monet_mod_path=/ufs/fabian/scratch/monetdb/current/program-x86_64/lib/MonetDB:/ufs/fabian/scratch/monetdb/current/program-x86_64/lib/bin" --set "gdk_dbfarm=/ufs/fabian/scratch/monetdb/current/program-x86_64/var/MonetDB/dbfarm" --set "sql_logdir=/ufs/fabian/scratch/monetdb/current/program-x86_64/var/MonetDB/log" --set mapi_port=36933 --set sql_port=44855 --set xquery_port=59461 --set monet_prompt= --trace "--dbname=mTests_src_test_bugs" --dbinit="module(sql_server); sql_server_start();" ; echo ; echo Over..
# 20:14:43 >  

# Monet Database Server V4.9.3
# Copyright (c) 1993-2005, CWI. All rights reserved.
# Compiled for x86_64-redhat-linux-gnu/64bit with 64bit OIDs; dynamically linked.
# Visit http://monetdb.cwi.nl/ for further information.

printf("\nReady.\n");

Ready.
quit();

Over..

# 20:14:43 >  
# 20:14:43 >  Mtimeout -timeout 180 ./except-union-intersect-bug-sf-1146079.SQL except-union-intersect-bug-sf-1146079 
# 20:14:43 >  


# 20:14:43 >  
# 20:14:43 >  Mtimeout -timeout 60 java -jar /net/pegasus.ins.cwi.nl/export/scratch1/fabian/monetdb/current/build-pegasus.ins.cwi.nl/sql/src/jdbc/jdbcclient-1.2.jar -h localhost -p 44855 -e -f ../../../../..//current/sql/src/test/bugs/Tests/../except-union-intersect-bug-sf-1146079.sql
# 20:14:43 >  

START TRANSACTION;
Operation successful


CREATE TABLE "a" (
	"property" int	NOT NULL,
	"class"    int	NOT NULL,
	CONSTRAINT "a_property_class_pkey" PRIMARY KEY ("class", "property")
);
Operation successful


INSERT INTO "a" VALUES (1, 17);
1 affected row

INSERT INTO "a" VALUES (21, 17);
1 affected row

INSERT INTO "a" VALUES (22, 17);
1 affected row

INSERT INTO "a" VALUES (20, 2);
1 affected row

INSERT INTO "a" VALUES (19, 17);
1 affected row

INSERT INTO "a" VALUES (4, 16);
1 affected row

INSERT INTO "a" VALUES (5, 16);
1 affected row

INSERT INTO "a" VALUES (6, 16);
1 affected row

INSERT INTO "a" VALUES (29, 16);
1 affected row

INSERT INTO "a" VALUES (12, 16);
1 affected row

INSERT INTO "a" VALUES (13, 11);
1 affected row

INSERT INTO "a" VALUES (26, 16);
1 affected row

INSERT INTO "a" VALUES (25, 16);
1 affected row

INSERT INTO "a" VALUES (23, 18);
1 affected row

INSERT INTO "a" VALUES (24, 18);
1 affected row

INSERT INTO "a" VALUES (15, 16);
1 affected row



-- table b differs from a that 50% of the values are decreased by 1 (last part)
CREATE TABLE "b" (
	"property" int	NOT NULL,
	"class"    int	NOT NULL,
	CONSTRAINT "b_property_class_pkey" PRIMARY KEY ("class", "property")
);
Operation successful


INSERT INTO "b" VALUES (1, 17);
1 affected row

INSERT INTO "b" VALUES (21, 17);
1 affected row

INSERT INTO "b" VALUES (22, 17);
1 affected row

INSERT INTO "b" VALUES (20, 2);
1 affected row

INSERT INTO "b" VALUES (19, 17);
1 affected row

INSERT INTO "b" VALUES (4, 16);
1 affected row

INSERT INTO "b" VALUES (5, 16);
1 affected row

INSERT INTO "b" VALUES (6, 16);
1 affected row

INSERT INTO "b" VALUES (28, 15);
1 affected row

INSERT INTO "b" VALUES (11, 15);
1 affected row

INSERT INTO "b" VALUES (12, 10);
1 affected row

INSERT INTO "b" VALUES (25, 15);
1 affected row

INSERT INTO "b" VALUES (24, 15);
1 affected row

INSERT INTO "b" VALUES (23, 17);
1 affected row

INSERT INTO "b" VALUES (14, 15);
1 affected row


-- make it permanent
COMMIT;
Operation successful


-- simple check whether everything is there
START TRANSACTION;
Operation successful

SELECT * FROM a;
+----------+-------+
| property | class |
+==========+=======+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
|       29 |    16 |
|       12 |    16 |
|       13 |    11 |
|       26 |    16 |
|       25 |    16 |
|       23 |    18 |
|       24 |    18 |
|       15 |    16 |
+----------+-------+
16 rows

SELECT * FROM b;
+----------+-------+
| property | class |
+==========+=======+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
|       28 |    15 |
|       11 |    15 |
|       12 |    10 |
|       25 |    15 |
|       24 |    15 |
|       23 |    17 |
|       14 |    15 |
+----------+-------+
15 rows

ROLLBACK;
Operation successful


-- require an upcast from sht to int
START TRANSACTION;
Operation successful

SELECT class FROM a EXCEPT SELECT 16; -- all but 16
+--------+
| class |
+========+
|    17 |
|     2 |
|    11 |
|    18 |
+--------+
4 rows

SELECT class FROM a UNION SELECT 16; -- all with 16 (distinct so invisible)
+--------+
| class |
+========+
|    17 |
|     2 |
|    16 |
|    11 |
|    18 |
+--------+
5 rows

SELECT class FROM a INTERSECT SELECT 16; -- just 16
+--------+
| class |
+========+
|    16 |
+--------+
1 row

ROLLBACK;
Operation successful


-- do the same with a real table
START TRANSACTION;
Operation successful

SELECT * FROM a EXCEPT SELECT * FROM b; -- should be last 50% of a
+----------+--------+
| property | class |
+==========+========+
|       29 |    16 |
|       12 |    16 |
|       13 |    11 |
|       26 |    16 |
|       25 |    16 |
|       23 |    18 |
|       24 |    18 |
|       15 |    16 |
+----------+--------+
8 rows

SELECT * FROM a UNION SELECT * FROM b; -- should be a + last 50% of b
+----------+--------+
| property | class |
+==========+========+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
|       29 |    16 |
|       12 |    16 |
|       13 |    11 |
|       26 |    16 |
|       25 |    16 |
|       23 |    18 |
|       24 |    18 |
|       15 |    16 |
|       28 |    15 |
|       11 |    15 |
|       12 |    10 |
|       25 |    15 |
|       24 |    15 |
|       23 |    17 |
|       14 |    15 |
+----------+--------+
23 rows

SELECT * FROM a INTERSECT SELECT * FROM b; -- should be first 50% of a
+----------+--------+
| property | class |
+==========+========+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
+----------+--------+
8 rows

ROLLBACK;
Operation successful


-- now check the non-duplicate removing versions
-- (they are very tricky, so be on your marks!)
START TRANSACTION;
Operation successful

SELECT class FROM a EXCEPT ALL SELECT 16; -- all but one 16 (will have 16 in output!)
+--------+
| class |
+========+
|    17 |
|    17 |
|    17 |
|    17 |
|     2 |
|    16 |
|    16 |
|    16 |
|    16 |
|    16 |
|    16 |
|    16 |
|     11 |
|     18 |
|     18 |
+--------+
15 rows

SELECT class FROM a UNION ALL SELECT 16; -- all plus 16
+--------+
| class |
+========+
|    17 |
|    17 |
|    17 |
|     2 |
|    17 |
|    16 |
|    16 |
|    16 |
|    16 |
|    16 |
|    11 |
|    16 |
|    16 |
|    18 |
|    18 |
|    16 |
|    16 |
+--------+
17 rows

SELECT class FROM a INTERSECT ALL SELECT 16; -- just one 16 (!)
+--------+
| class |
+========+
|    16 |
+--------+
1 row

ROLLBACK;
Operation successful


-- do the same with a real table (because our tables have a key on both
-- columns we also use only the first column here, as otherwise the ALL
-- would never be tested for tables)
START TRANSACTION;
Operation successful

SELECT * FROM a EXCEPT ALL SELECT * FROM b; -- last 50% of a
+----------+--------+
| property | class |
+==========+========+
|       29 |    16 |
|       12 |    16 |
|       13 |    11 |
|       26 |    16 |
|       25 |    16 |
|       23 |    18 |
|       24 |    18 |
|       15 |    16 |
+----------+--------+
8 rows

SELECT class FROM a EXCEPT ALL SELECT class FROM b; -- a minus the elements from b that are in a (if count(x) in a > count(x) in b, x will appear in output)
+--------+
| class |
+========+
|    16 |
|    16 |
|    16 |
|    16 |
|    16 |
|     11 |
|     18 |
|     18 |
+--------+
8 rows

SELECT * FROM a UNION ALL SELECT * FROM b; -- a + b
+----------+--------+
| property | class |
+==========+========+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
|       29 |    16 |
|       12 |    16 |
|       13 |    11 |
|       26 |    16 |
|       25 |    16 |
|       23 |    18 |
|       24 |    18 |
|       15 |    16 |
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
|       28 |    15 |
|       11 |    15 |
|       12 |    10 |
|       25 |    15 |
|       24 |    15 |
|       23 |    17 |
|       14 |    15 |
+----------+--------+
31 rows

SELECT * FROM a INTERSECT ALL SELECT * FROM b; -- first 50% of a
+----------+--------+
| property | class |
+==========+========+
|        1 |    17 |
|       21 |    17 |
|       22 |    17 |
|       20 |     2 |
|       19 |    17 |
|        4 |    16 |
|        5 |    16 |
|        6 |    16 |
+----------+--------+
8 rows

SELECT class FROM a INTERSECT ALL SELECT class FROM b; -- only those that are both in a and b (min(count(a, x), count(b, x)) !!!
+--------+
| class |
+========+
|    17 |
|    17 |
|    17 |
|    17 |
|     2 |
|    16 |
|    16 |
|    16 |
+--------+
8 rows

ROLLBACK;
Operation successful


-- cleanup! (also should cascade into dropping the index)
START TRANSACTION;
Operation successful

DROP TABLE "a";
Operation successful

DROP TABLE "b";
Operation successful

COMMIT;
Operation successful


# 20:14:43 >  
# 20:14:43 >  Done.
# 20:14:43 >  

