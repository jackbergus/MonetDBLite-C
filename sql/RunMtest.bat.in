@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

set monetdb5_prefix=@XMONETDB5_PREFIX@

call "%monetdb5_prefix%\bin\monetdb5-config.bat" --internal

set pkg=monetdb-sql
set builddir=@XSQL_BUILD@
set srcdir=@XSQL_SOURCE@

set MOD_PATH=%modpath%
set MOD_PATH=%builddir%\src\sql;%MOD_PATH%
set MOD_PATH=%builddir%\src\backends\monet5;%MOD_PATH%
set MOD_PATH=%builddir%\src\backends\monet5\.libs;%MOD_PATH%

REM enable auto-loading of modules before `make install`
if not exist %builddir%\src\backends\monet5\autoload mkdir %builddir%\src\backends\monet5\autoload
copy /y %srcdir%\src\backends\monet5\??_*.mal %builddir%\src\backends\monet5\autoload

set PATH=%MOD_PATH%;%PATH%
set PATH=%builddir%\src\server;%PATH%
set PATH=%builddir%\src\storage\bat;%PATH%
set PATH=%builddir%\src\common;%PATH%
set PATH=%builddir%\conf;%PATH%

set PYTHONPATH=%builddir%\src\backends\python\monet5;%PYTHONPATH%

REM execute Mtest.py in the source directory
pushd %srcdir%

call Mtest.py "--package=%pkg%" "--monet_mod_path=%MOD_PATH%" "--dbfarm=%builddir%\dbfarm" "--TSTTRGBASE=%builddir%" %1 %2 %3 %4 %5 %6 %7 %8 %9

popd
endlocal

:end
