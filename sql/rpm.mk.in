# -*- makefile -*-

# The contents of this file are subject to the MonetDB Public License
# Version 1.1 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
# http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
# License for the specific language governing rights and limitations
# under the License.
#
# The Original Code is the MonetDB Database System.
#
# The Initial Developer of the Original Code is CWI.
# Portions created by CWI are Copyright (C) 1997-2007 CWI.
# All Rights Reserved.

# make rules to generate MonetDB RPMs (works on RedHat Linux, only)

rpmtopdir = $(shell cd $(top_builddir) && pwd)/rpm

@HAVE_PYTHON_SWIG_FALSE@python=--without python
@HAVE_PYTHON_SWIG_TRUE@python=--with python
@HAVE_MONETDB4_FALSE@monetdb4=--without monetdb4
@HAVE_MONETDB4_TRUE@monetdb4=--with monetdb4
@HAVE_MONETDB5_FALSE@monetdb5=--without monetdb5
@HAVE_MONETDB5_TRUE@monetdb5=--with monetdb5

$(top_builddir)/$(distdir).tar.gz:
	$(MAKE) $(AM_MAKEFLAGS) dist

$(rpmtopdir)/rpmmacros:
	mkdir -p $(rpmtopdir)/RPMS
	mkdir -p $(rpmtopdir)/SRPMS
	mkdir -p $(rpmtopdir)/SPECS
	mkdir -p $(rpmtopdir)/BUILD
	mkdir -p $(rpmtopdir)/INSTALL

	echo "macrofiles: /usr/lib/rpm/macros:/usr/lib/rpm/%{_target}/macros:/etc/rpm/macros.specspo:/etc/rpm/macros.prelink:/etc/rpm/macros.solve:/etc/rpm/macros.up2date:/etc/rpm/macros:/etc/rpm/%{_target}/macros:$(rpmtopdir)/rpmmacros" > $(rpmtopdir)/rpmrc

	echo "%_tmppath          /tmp"                >  $(rpmtopdir)/rpmmacros
	echo "%_topdir           $(rpmtopdir)"        >> $(rpmtopdir)/rpmmacros
	echo "%tmpdir            %{_tmppath}"         >> $(rpmtopdir)/rpmmacros
	echo "%rpmcflags         -O2 "                >> $(rpmtopdir)/rpmmacros
	echo "#%top_builddirroot %{_topdir}/INSTALL/" >> $(rpmtopdir)/rpmmacros
	echo "%dist              _@LINUX_DIST@"       >> $(rpmtopdir)/rpmmacros
	if test "@oids@" -eq 32; then echo "%oid32 1" >> $(rpmtopdir)/rpmmacros; fi

rpm:	MonetDB-SQL.spec $(top_builddir)/$(distdir).tar.gz $(rpmtopdir)/rpmmacros
	$(RPMBUILD) --rcfile $(rpmtopdir)/rpmrc -ta --target `uname -m` ${python} ${monetdb4} ${monetdb5} --define="buildsystem 1" --define="comp_cc @CC@" $(top_builddir)/$(distdir).tar.gz
	for i in rpm/SRPMS/*_@LINUX_DIST@.oid@oids@* ; do \
		mv "$$i" "`echo "$$i" | sed 's|_@LINUX_DIST@.oid@oids@||'`" ; \
	done
	rm -rf $(rpmtopdir)/BUILD

srpm:	MonetDB-SQL.spec $(top_builddir)/$(distdir).tar.gz $(rpmtopdir)/rpmmacros
	$(RPMBUILD) --rcfile $(rpmtopdir)/rpmrc -ts ${python} ${monetdb4} ${monetdb5} --define="buildsystem 1" $(top_builddir)/$(distdir).tar.gz
	for i in rpm/SRPMS/*_@LINUX_DIST@.oid@oids@* ; do \
		mv "$$i" "`echo "$$i" | sed 's|_@LINUX_DIST@.oid@oids@||'`" ; \
	done

cleanup_distr:
	find sql-* -perm -0100 -type f ! -name \*.bat ! -name \*.sh ! -exec grep -q '^#!' {} \; -exec chmod a-x {} \;
	find sql-* -name \*.in ! -name configure.in ! -name \*.spec.in -print | while read i; do test -f $${i%.in} && rm -f $${i%.in}; done || true

dist-hook: cleanup_distr
