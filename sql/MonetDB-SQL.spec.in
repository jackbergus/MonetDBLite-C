# groups of related archs
%define all_x86 i386 i586 i686

%ifarch %{all_x86}
%define bits 32
%else
%define bits 64
%endif

%define name MonetDB-SQL
%define version @VERSION@
%define release 1%{?dist}%{?oid32:.oid32}%{!?oid32:.oid%{bits}}

%define prefix /usr

Name: %{name}
Version: %{version}
Release: %{release}
Summary: MonetDB SQL - Monet Database Management System
Group: System
Source: sql-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-root
Packager: Niels Nes <Niels.Nes@cwi.nl>
License:   MPL - http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html

%{!?_with_python: %{!?_without_python: %define _with_python --with-python}}
%{!?_with_monetdb4: %{!?_without_monetdb4: %define _with_monetdb4 --with-monetdb4}}
%{!?_with_monetdb5: %{!?_without_monetdb5: %define _with_monetdb5 --with-monetdb5}}
%{!?buildsystem: %define buildsystem 0}
%if !%{?buildsystem}
# this should become MonetDB-client-devel
BuildRequires: %{prefix}/include/MonetDB/mapilib/Mapi.h
# this only needed due to faulty BuildRequires in MonetDB-client 1.18.0
BuildRequires: readline-devel, openssl-devel
# this only needed due to faulty BuildRequires in MonetDB 1.18.0
BuildRequires: zlib-devel, bzip2-devel
BuildRequires: MonetDB-devel >= 1.18
#                               ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
BuildRequires: MonetDB-client-devel >= 1.19
#                                      ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%endif
%if %{?_with_python:1}%{!?_with_python:0}
Requires: python
%if !%{?buildsystem}
BuildRequires: python, python-devel, swig
%endif
%endif

%if %{?_with_monetdb4:1}%{!?_with_monetdb4:0}
%package server4
Summary: MonetDB4 SQL server modules
Group: System 
Requires: MonetDB4-server >= 4.19
#                            ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%if !%{?buildsystem}
BuildRequires: MonetDB4-server-devel >= 4.19
#                                       ^^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%endif

%description server4
Add the MonetDB4 SQL server module description here

%endif

%if %{?_with_monetdb5:1}%{!?_with_monetdb5:0}
%package server5
Summary: MonetDB5 SQL server modules
Group: System 
Requires: MonetDB5-server = 5.1
#                           ^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%if !%{?buildsystem}
BuildRequires: MonetDB5-server-devel >= 5.1
#                                       ^^^
# Maintained via vertoo. Please don't modify by hand!
# Contact MonetDB-developers@lists.sourceforge.net for details and/or assistance.
%endif

%description server5
Add the MonetDB5 SQL server module description here

%endif

# %package devel
# Summary: MonetDB SQL development package 
# Group: System 
# %if %{?_with_monetdb4:1}%{!?_with_monetdb4:0}
# Requires: %{name}-server4
# Requires: MonetDB4-server-devel
# %endif
# %if %{?_with_monetdb5:1}%{!?_with_monetdb5:0}
# Requires: %{name}-server5
# Requires: MonetDB5-server-devel
# %endif
# Requires: MonetDB-devel
# Requires: MonetDB-client-devel

%description
MonetDB is a database management system that is developed from a
main-memory perspective with use of a fully decomposed storage model,
automatic index management, extensibility of data types and search
accellerators, SQL- and XML- frontends.

# %description devel
# Add the MonetDB devel description here

%prep
rm -rf $RPM_BUILD_ROOT

%setup -q -n sql-%{version}

%build

./configure \
	--enable-assert=no \
	--enable-optimize \
	--enable-bits=%{bits} \
	%{?oid32:--enable-oid32} \
	%{?comp_cc:CC="%{comp_cc}"} \
	--prefix=%{prefix} \
	--libdir=%{_libdir} \
	--with-monetdb=%{prefix} \
	--with-clients=%{prefix} \
	%{?_with_monetdb4} %{?_without_monetdb4} \
	%{?_with_monetdb5} %{?_without_monetdb5} 

make

%install
rm -rf $RPM_BUILD_ROOT

make install \
	DESTDIR=$RPM_BUILD_ROOT 

#find $RPM_BUILD_ROOT -name .incs.in | xargs rm
find $RPM_BUILD_ROOT -name \*.la | xargs rm -f

# cleanup stuff we don't want to install
rm -rf $RPM_BUILD_ROOT%{_libdir}/MonetDB4/Tests/*
rm -rf $RPM_BUILD_ROOT%{prefix}/lib*/python*/site-packages
rm -rf $RPM_BUILD_ROOT%{prefix}/include/sql
rm -rf $RPM_BUILD_ROOT%{_libdir}/pkgconfig/MonetDB-SQL.pc
rm -rf $RPM_BUILD_ROOT%{prefix}/bin/monetdb-sql-config.bat
# remove the following line, once we add it to %files devel, below
rm -rf $RPM_BUILD_ROOT%{prefix}/bin/monetdb-sql-config

# Fixes monet config script
#perl -p -i -e "s|$RPM_BUILD_ROOT||" $RPM_BUILD_ROOT%{prefix}/bin/monet_config

%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,root) 
%{_datadir}/MonetDB/sql/*
%{_datadir}/doc/%{name}-%{version}/*

%if %{?_with_monetdb4:1}%{!?_with_monetdb4:0}
%files server4
%defattr(-,root,root) 
%{prefix}/bin/Mbeddedsql
%{_libdir}/libembeddedsql.*
%{_libdir}/MonetDB4/lib/lib_sql_server*
%{_libdir}/MonetDB4/*.mil
%{prefix}/include/embeddedclient.h
%endif

%if %{?_with_monetdb5:1}%{!?_with_monetdb5:0}
%files server5
%defattr(-,root,root) 
#%{prefix}/bin/Mbeddedsql
#%{_libdir}/libembeddedsql.*
%{prefix}/bin/Mbeddedsql5
%{_libdir}/libembeddedsql5.*
%{_libdir}/MonetDB5/lib/lib_sql*
%{_libdir}/MonetDB5/*.mal
%endif

# %files devel
# %defattr(-,root,root) 
# %{_libdir}/pkgconfig/MonetDB-SQL.pc
# # when activating the following line, don't remove the file during cleanup above
# %{prefix}/bin/monetdb-sql-config

%changelog
* Mon Jun 25 2007 Sjoerd Mullender <sjoerd@acm.org> - @VERSION@-1
- Built.

