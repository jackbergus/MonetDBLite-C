%define name MonetDB-SQL
%define version @VERSION@
%define release 1_@LINUX_DIST@.oid@oids@

%define prefix /usr

Name: %{name}
Version: %{version}
Release: %{release}
Summary: MonetDB SQL - Monet Database Management System
Group: System
Source: sql-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-root
Packager: Niels Nes <Niels.Nes@cwi.nl>
License:   MPL - http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
Requires: python

%{!?buildsystem: %define buildsystem 0}
%if !%{?buildsystem}
BuildRequires: MonetDB-devel 
%endif

%{!?_with_java: %{!?_without_java: %define _with_java --with-java}}
%{!?_with_python: %{!?_without_python: %define _with_python --with-python}}
%define comp_cc @CC@
%define builddoc 0

# groups of related archs
%define all_x86 i386 i586 i686

%ifarch %{all_x86}
%define bits 32
%else
%define bits 64
%endif

%package odbc
Summary: MonetDB SQL odbc
Group: System

%if %{?_with_java:1}%{!?_with_java:0}
%package java
Summary: MonetDB SQL java interface
Group: System
%if !%{?buildsystem}
BuildRequires: java ant
%endif
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%package python
Summary: MonetDB SQL python interface
Group: System
%if !%{?buildsystem}
BuildRequires: python swig
%endif
%endif

%package server
Summary: MonetDB SQL server modules
Group: System 

%package devel
Summary: MonetDB SQL development package 
Group: System 

%if %{builddoc}
%package docu
Summary: MonetDB SQL documentation package 
Group: System 
%endif

%description
MonetDB is a database management system that is developed from a
main-memory perspective with use of a fully decomposed storage model,
automatic index management, extensibility of data types and search
accellerators, SQL- and XML- frontends.

%description odbc
Add the MonetDB SQL odbc description here
Requires: MonetDB-client

%if %{?_with_java:1}%{!?_with_java:0}
%description java
Add the MonetDB SQL java description here
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%description python
Add the MonetDB SQL python description here
Requires: %{name}-odbc
Requires: python
%define python_libdir %(python -c 'import distutils.sysconfig; print distutils.sysconfig.get_python_lib(1,0,"")')
%endif

%description server
Add the MonetDB SQL server module description here
Requires: %{name}-odbc
Requires: MonetDB-server

%description devel
Add the MonetDB devel description here
Requires: %{name}-server
Requires: MonetDB-devel

%if %{builddoc}
%description docu
Add the MonetDB documentaion description here
%endif

%prep
rm -rf $RPM_BUILD_ROOT

%setup -q -n sql-%{version}

%build

./configure \
	--enable-assert=no \
	--enable-optimize \
	--enable-bits=%{bits} \
	CC="%{comp_cc}" \
	--prefix=%{prefix} \
	--libdir=%{_libdir} \
	--with-monet=%{prefix} \
	%{?_with_python} %{?_without_python} \
	%{?_with_java} %{?_without_java} \

make

%install
rm -rf $RPM_BUILD_ROOT

make install \
	DESTDIR=$RPM_BUILD_ROOT 

#find $RPM_BUILD_ROOT -name .incs.in | xargs rm

# Fixes monet config script
#perl -p -i -e "s|$RPM_BUILD_ROOT||" $RPM_BUILD_ROOT%{prefix}/bin/monet_config

%clean
rm -rf $RPM_BUILD_ROOT

%files odbc
%defattr(-,monetdb,monetdb) 
%{_libdir}/libMonetODBC*
%{_libdir}/sql/Tests/odbcsample1

%if %{?_with_java:1}%{!?_with_java:0}
%files java
%defattr(-,monetdb,monetdb)
%{prefix}/share/MonetDB/lib/*.jar
%{prefix}/share/sql/Tests/Test_*.class
%endif

%if %{?_with_python:1}%{!?_with_python:0}
%files python
%defattr(-,monetdb,monetdb) 
%{prefix}/%{python_libdir}/*
%endif

%files server
%defattr(-,monetdb,monetdb) 
%{prefix}/bin/Mbeddedsql
%{_libdir}/libembeddedsql.*
%{_libdir}/MonetDB/lib/lib_sql_server*
%{_libdir}/MonetDB/*.mil

%files devel
%defattr(-,monetdb,monetdb) 
%{prefix}/include/*.h
%{prefix}/include/sql/*.h
%{_libdir}/sql/Tests/*
%{_libdir}/pkgconfig/MonetDB-SQL.pc

%if %{builddoc}
%files docu
%defattr(-,monetdb,monetdb) 
%{prefix}/share/MonetDB/docs/SQL/*.html
%{prefix}/share/MonetDB/docs/SQL/*.pdf
%{prefix}/share/MonetDB/docs/SQL/*.ps
%{prefix}/share/MonetDB/docs/SQL/*/*.html
%{prefix}/share/MonetDB/docs/SQL/*/*.pdf
%{prefix}/share/MonetDB/docs/SQL/*/*.ps
%endif
