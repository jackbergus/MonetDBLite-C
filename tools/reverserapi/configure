#!/bin/sh
# curl http://homepages.cwi.nl/~hannes/R/embedded.tgz > arch.tgz
# rm -rf src
# mkdir src
# tar xvf arch.tgz -C src
# rm arch.tgz
cd src

CFLAGS="-I$R_INCLUDE_DIR" ./configure --prefix=$R_PACKAGE_DIR/install \
--enable-embedded  --disable-fits --disable-geom --disable-rintegration --disable-gsl --disable-netcdf \
--disable-jdbc --disable-merocontrol --disable-odbc --disable-console --disable-microhttpd \
--without-perl --without-python2 --without-python3 --without-rubygem --without-unixodbc \
--without-samtools --without-sphinxclient --without-geos --without-samtools --without-readline \
--enable-optimize --enable-silent-rules

# Dirty hack, normally R would call make, but we need to also do a make install to get the libs in place. 
# So we do it ourselves instead and then render the MonetDB makefile inert.
make -j clean install

echo -e "dummytarget:\n\ttrue\n" > Makefile
cd ..

# Normally, the installer would create the libs dir, but only after make, so we need to create this as well
mkdir -p $R_PACKAGE_DIR/libs/

# and finally put the embedded library where R expects it
RDYNLIB=$R_PACKAGE_DIR/libs/MonetDB.so
# TODO: this number should probably be pulled from automake and friends
VER=1
if [ -f "$R_PACKAGE_DIR/install/lib/libembedded.$VER.dylib" ]; then
    ln -s $R_PACKAGE_DIR/install/lib/libembedded.$VER.dylib $RDYNLIB
fi
if [ -f "$R_PACKAGE_DIR/install/lib/libembedded.so.$VER" ]; then
    ln -s $R_PACKAGE_DIR/install/lib/libembedded.so.$VER $RDYNLIB
fi
# TODO: Windows case (shudder)
if [ ! -f $RDYNLIB ]; then
	echo "configure/build failure"
    exit -1
fi
