#!/usr/bin/env bash

# The contents of this file are subject to the MonetDB Public License
# Version 1.1 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
# http://www.monetdb.org/Legal/MonetDBLicense
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
# License for the specific language governing rights and limitations
# under the License.
#
# The Original Code is the MonetDB Database System.
#
# The Initial Developer of the Original Code is CWI.
# Portions created by CWI are Copyright (C) 1997-July 2008 CWI.
# Copyright August 2008-2011 MonetDB B.V.
# All Rights Reserved.

# Make a clone from a local database on a remote server.
# usage: monetdbbincopy <dbname> <passphrase> <host-list> 
# copies <dbname> to <host> 

# The passphrase should be sent as well for remote servers

dbname=$1
passphrase=$2
shift 2 
hostlist=$*

if [[ -z ${dbname} || -z ${passphrase} ]] ; then
	echo "usage: monetdbbincopy <dbname> <passphrase> <host-list>"
	exit 1
fi

# we presume monetdb, mclient, etc. are in PATH

# check if the database exists at the remote site
#monetdb -h$host -P$passphrase create $dbname || exit 1
#rpath=$(monetdb -h$host -P$passphrase status -l $dbname | grep "location:" | cut -d: -f2)

# take the local database down
# we don't care if the database is already locked
monetdb lock $dbname 
# and if it's already stopped it's fine too
monetdb stop $dbname
lpath=$(monetdb status -l $dbname | grep "location:" | cut -d: -f2)

for host in ${hostlist} ; do
	echo `date +%D:%H:%M`"start the copy to ${host}"
	monetdb -h$host -P$passphrase create $dbname 
	rpath=$(monetdb -h$host -P$passphrase status -l $dbname | grep "location:" | cut -d: -f2)
	ssh -n $host "mnc -l -B $host 54321 | tar -C $rpath -jxf -" &
	there=$!
	tar -C ${lpath} --exclude=.mapi.sock -jcf - . | mnc -B $host 54321
	wait $there
	monetdb -h$host -P$passphrase release $dbname
done
echo `date +%D:%H:%M`"done"
monetdb release $dbname
