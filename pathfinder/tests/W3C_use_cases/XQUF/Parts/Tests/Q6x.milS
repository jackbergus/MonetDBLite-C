module(ascii_io);
module(unix);
module(pathfinder);
var TSTSRCDIR := getenv("TSTSRCDIR");
shred_doc(TSTSRCDIR+"/part-list.xml", "part-list.xml", "Parts", 9LL);
shred_doc(TSTSRCDIR+"/part-tree.xml", "part-tree.xml", "Parts", 9LL);

xquery("xml","
for $keyword at $i in (\"car\", \"skateboard\", \"canoe\")
for $parent in doc(\"part-tree.xml\")//part[@name=$keyword]
let $descendants := $parent//part
for $p in ($parent, $descendants)
return 
  do replace value of exactly-one($p/@partid) with $i*1000+$p/@partid
").printf();
fflush(stdout());
fflush(stderr());

xquery("xml","
doc(\"part-list.xml\")
").printf();
fflush(stdout());
fflush(stderr());

xquery("xml","
doc(\"part-tree.xml\")
").printf();
fflush(stdout());
fflush(stderr());

delete_doc("part-list.xml");
delete_doc("part-tree.xml");
