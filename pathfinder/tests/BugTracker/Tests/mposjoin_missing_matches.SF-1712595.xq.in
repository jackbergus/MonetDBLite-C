declare function deep-equal($node1 as node(), $node2 as node()) as xs:boolean
{
  let $e1 := $node1/descendant-or-self::element()
     ,$e2 := $node2/descendant-or-self::element()
  return
  if (count($e1) eq count($e2))
  then let $e1s := for $e in $e1 return ($e/name(),$e/string())
          ,$e2s := for $e in $e2 return ($e/name(),$e/string())
       return string-join($e1s,",") eq string-join($e2s,",")
  else false()
};

let $doc := doc("$TSTSRCDIR/mposjoin_missing_matches.SF-1712595.imdb2.xml")
return deep-equal(<a>{$doc}</a>,<a>{$doc}</a>)
