declare function local:normCompanyName($name as xs:string) as xs:string {
 normalize-space(replace(
   upper-case(translate($name,",./()-","      "))
 ,"LIMITED","LTD"))
};

declare function local:companyList($rootnode as node()*) {
   let $all := $rootnode//company/addressbook/name
   let $uniqueNames := distinct-values(for $i in $all
                                       return local:normCompanyName($i))
   for $i in $uniqueNames
   let $firstNode := $all[local:normCompanyName(.)=$i][1]
   return $firstNode/../..
};

let $col := doc("$TSTSRCDIR/child-steps-and-replace.SF-2716723.xml")
return local:companyList($col)
