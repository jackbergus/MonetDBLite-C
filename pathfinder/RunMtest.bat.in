@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

rem default back end is MonetDB4
set V=4
if "%1" == "-4" set V=4& shift
if "%1" == "-5" set V=5& shift

set monetdb4_prefix=@XMONETDB4_PREFIX@
set monetdb5_prefix=@XMONETDB5_PREFIX@

if %V% == 4 call "%monetdb4_prefix%\bin\monetdb4-config.bat" --internal
if %V% == 5 call "%monetdb5_prefix%\bin\monetdb5-config.bat" --internal

set pkg=monetdb-xquery
set buildbase=@XBUILD@
set builddir=%buildbase%\pathfinder
set srcdir=@XSOURCE@\pathfinder

set MOD_PATH=%modpath%
set MOD_PATH=%builddir%\modules\pftijah;%MOD_PATH%
set MOD_PATH=%builddir%\modules\pftijah\.libs;%MOD_PATH%
set MOD_PATH=%builddir%\runtime;%MOD_PATH%
set MOD_PATH=%builddir%\runtime\.libs;%MOD_PATH%

set PATH=%MOD_PATH%;%PATH%
set PATH=%builddir%\compiler;%PATH%
set PATH=%builddir%\src\tools;%PATH%

set PYTHONPATH=%buildbase%\testing\src;%PYTHONPATH%

REM execute Mtest.py in the source directory
pushd %srcdir%

call "%buildbase%\testing\src\Mtest.py" -%V% --package=%pkg% "--monet_mod_path=%MOD_PATH%" "--dbfarm=%builddir%\dbfarm" "--xrpc_docroot=%srcdir%\runtime\xrpc" "--TSTSRCBASE=%srcdir%" "--TSTTRGBASE=%builddir%" %1 %2 %3 %4 %5 %6 %7 %8 %9

popd
endlocal

:end
