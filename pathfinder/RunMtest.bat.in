@echo off

if not "%1"=="" goto skip
call %0 -rq
goto end

:skip

setlocal

rem default back end is monetdb4
set V=4
if "%1" == "-4" set V=4& shift
if "%1" == "-5" set V=5& shift

set pkg=pathfinder
set buildbase=@XBUILD@
set builddir=%buildbase%\pathfinder
set srcdir=@XSOURCE@\pathfinder

set MOD_PATH=%builddir%\runtime\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\runtime
set MOD_PATH=%MOD_PATH%;%builddir%\modules\pftijah\.libs
set MOD_PATH=%MOD_PATH%;%builddir%\modules\pftijah

if not %V% == 4 goto skip_4
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\plain\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\plain
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\contrib\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\contrib
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\calibrator\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\calibrator
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mapi\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mapi
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mnetcdf\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb4\modules\mnetcdf
set MOD_PATH=%MOD_PATH%;%srcdir%\..\monetdb4\scripts\tools
:skip_4

if not %V% == 5 goto skip_5
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\compiler\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\compiler
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\optimizer\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\optimizer
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\scheduler\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\scheduler
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\atoms\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\atoms
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\kernel\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\kernel
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\mal\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\modules\mal
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\crackers\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\crackers
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\rdf\.libs
set MOD_PATH=%MOD_PATH%;%buildbase%\monetdb5\extras\rdf

REM enable auto-loading of modules before `make install`
if not exist %buildbase%\monetdb5\extras\rdf\autoload mkdir %buildbase%\monetdb5\extras\rdf\autoload
copy /y %srcdir%\..\monetdb5\extras\rdf\??_*.mal %buildbase%\monetdb5\extras\rdf\autoload
if not exist %buildbase%\monetdb5\modules\atoms\autoload mkdir %buildbase%\monetdb5\modules\atoms\autoload
copy /y %srcdir%\..\monetdb5\modules\atoms\??_*.mal %buildbase%\monetdb5\modules\atoms\autoload
:skip_5

set PATH=%buildbase%\monetdb%V%\tools;%buildbase%\testing\src;%PATH%

set PATH=%MOD_PATH%;%PATH%
set PATH=%builddir%\extras\compiler;%PATH%
set PATH=%builddir%\tools;%PATH%

set PYTHONPATH=%buildbase%\testing\src;%srcdir%\..\testing\src;%PYTHONPATH%

REM execute Mtest.py in the source directory
pushd %srcdir%

call "%buildbase%\testing\src\Mtest.py" -%V% --package=%pkg% "--monet_mod_path=%MOD_PATH%" "--dbfarm=%builddir%\dbfarm" "--xrpc_docroot=%srcdir%\runtime\xrpc" "--TSTTRGBASE=%builddir%" %1 %2 %3 %4 %5 %6 %7 %8 %9

popd
endlocal

:end
