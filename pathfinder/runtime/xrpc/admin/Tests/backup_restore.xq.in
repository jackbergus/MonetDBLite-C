(:
  1. show current documents in DB
  2. backup current DB
  3. delete all documents in DB
  4. restore backup

  Test the following admin functions:
  - adm:add-doc()
  - adm:documents()
  - adm:backup()
  - adm:backup-col()
  - adm:del-col()
  - adm:del-doc()
  - adm:restore()
  - adm:restore-col()
:)
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
(execute at {"$HOST:$XRPCPORT"}
            {adm:add-doc("$TSTSRCBASE/runtime/xrpc/admin/xmark1.xml",
                         "xmark1.xml", "xmark", 10)},
 execute at {"$HOST:$XRPCPORT"}
            {adm:add-doc("$TSTSRCBASE/runtime/xrpc/admin/xmark2.xml",
                         "xmark2.xml", "xmark", 10)}
)
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
(
text {"&#10;  "},
<db-before-backup>{
    let $docs := execute at {"$HOST:$XRPCPORT"} {adm:documents()} return
        for $d in $docs return
            ( text { "&#10;    " },
              element document {
                element updatable {string($d/@updatable)},
                element collection {string($d/@collection)},
                $d/text() } ),
    text { "&#10;  "}
}</db-before-backup>,
text {"&#10;"}
)
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
execute at {"$HOST:$XRPCPORT"} {adm:backup("test")}
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
execute at {"$HOST:$XRPCPORT"} {adm:del-col("xmark")}
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
<db-after-del>{
    execute at {"$HOST:$XRPCPORT"} {adm:collections()}
}</db-after-del>
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
execute at {"$HOST:$XRPCPORT"} {adm:restore("test", 10)}
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
(
text {"&#10;  "},
<db-after-restore>{
    let $docs := execute at {"$HOST:$XRPCPORT"} {adm:documents()} return
        for $d in $docs return
            ( text { "&#10;    " },
              element document {
                element updatable {string($d/@updatable)},
                element collection {string($d/@collection)},
                element uri {string($d/@uri)},
                $d/text() } ),
    text { "&#10;  "}
}</db-after-restore>,
text {"&#10;"}
)
<>
(: clean DB at the end of the test :)
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
execute at {"$HOST:$XRPCPORT"} {adm:del-col("xmark")}
<>
import module namespace adm = "http://monetdb.cwi.nl/XQuery/admin/"
                        at "$TSTSRCBASE/runtime/xrpc/admin/admin.xq";
<db-after-cleanup>
{ execute at {"$HOST:$XRPCPORT"} {adm:documents()} }
</db-after-cleanup>


