#!/usr/bin/env bash

# The contents of this file are subject to the MonetDB Public License
# Version 1.1 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
# http://monetdb.cwi.nl/Legal/MonetDBLicense-1.1.html
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
# License for the specific language governing rights and limitations
# under the License.
#
# The Original Code is the MonetDB Database System.
#
# The Initial Developer of the Original Code is CWI.
# Portions created by CWI are Copyright (C) 1997-July 2008 CWI.
# Copyright August 2008-2010 MonetDB B.V.
# All Rights Reserved.

# helps bootstrapping MonetDB, when checked out from CVS
# requires GNU autoconf, automake and libtool
# this is not meant to go into the distributions


prefix="@prefix@"
datarootdir="@datarootdir@"
CONFDIR="-I @datadir@/@PACKAGE@"

AUTOGEN=`type -p autogen.py`
if [ "$AUTOGEN" -a -x "$AUTOGEN" ]; then
	# autogen.py was properly installed and found
	:
else
	echo "!ERROR: requires autogen.py to be available" >&2
	exit 1
fi

if [ "`uname`" = Darwin  -a  "`type -p glibtool 2>/dev/null`"  -a  "`type -p glibtoolize 2>/dev/null`" ] ; then
	LIBTOOL=glibtool
	LIBTOOLIZE=glibtoolize
	echo "using `type -p glibtool 2>/dev/null` and `type -p glibtoolize 2>/dev/null`."
  else
	LIBTOOL=libtool
	LIBTOOLIZE=libtoolize
fi


find . -name .incs.\* -exec rm {} \;
rm -rf autom4*.cache


# temporarly create fake-configure.in to give autoconf-wrappers a hint, which version we need:
cat << "EOF" > configure.in
AC_PREREQ(2.57)
AC_INIT(src/utils/Mx/Mx.h)
EOF


REQ_AM_VERSION="1.5"
NEW_AM_VERSION="1.7"
TAR_AM_VERSION="1.9"
if [ ! "`type -p automake`" ]; then
	echo "no automake found." >&2
	echo "We require (at least) automake $REQ_AM_VERSION." >&2
	echo "Please get it at eg. http://www.gnu.org/software/automake/." >&2
	exit 1
fi
AM_VERSION=`automake --version 2>/dev/null | sed -n -e '/^automake/{s/.* //g;s/-.*//g;p;q;}'`
_AM_VERSION=`echo $AM_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_REQ_AM_VERSION=`echo $REQ_AM_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_NEW_AM_VERSION=`echo $NEW_AM_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_TAR_AM_VERSION=`echo $TAR_AM_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`

if [ "$_AM_VERSION" -ge "$_NEW_AM_VERSION" ]; then
	echo "automake $AM_VERSION is $NEW_AM_VERSION or newer. Good."
elif [ "$_AM_VERSION" -ge "$_REQ_AM_VERSION" ]; then
	echo "automake $AM_VERSION is $REQ_AM_VERSION or newer. OK, unless you want to compile with Intel's icc (on Linux), which requires automake $NEW_AM_VERSION or newer."
elif [ "$_AM_VERSION" -lt "$_REQ_AM_VERSION" ]; then
	echo "automake $AM_VERSION is older than $REQ_AM_VERSION." >&2
	echo "We require (at least) automake $REQ_AM_VERSION (or $NEW_AM_VERSION to compile with Intel's icc (on Linux)." >&2
	echo "Please get a newer version (cf. http://www.gnu.org/software/automake/)." >&2
	exit 1
fi


REQ_AC_VERSION="2.57"
if [ ! "`type -p autoconf`" ]; then
	echo "no autoconf found." >&2
	echo "We require (at least) autoconf $REQ_AC_VERSION." >&2
	echo "Please get it at eg. http://www.gnu.org/software/autoconf/." >&2
	exit 1
fi
AC_VERSION=`autoconf --version 2>/dev/null | sed -n -e '/^[Aa]utoconf/{s/.* //g;s/-.*//g;p;q;}'`
_AC_VERSION=`echo $AC_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_REQ_AC_VERSION=`echo $REQ_AC_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`

if [ "$_AC_VERSION" -ge "$_REQ_AC_VERSION" ]; then
	echo "autoconf $AC_VERSION is $REQ_AC_VERSION or newer. Good."
elif [ "$_AC_VERSION" -lt "$_REQ_AC_VERSION" ]; then
	echo "autoconf $AC_VERSION is older than $REQ_AC_VERSION." >&2
	echo "We require (at least) autoconf $REQ_AC_VERSION." >&2
	echo "Please get a newer version (cf. http://www.gnu.org/software/autoconf/)." >&2
	exit 1
fi


REQ_LT_VERSION="1.4"
if [ ! "`type -p $LIBTOOL`" ]; then
	echo "no libtool found." >&2
	echo "We require (at least) libtool $REQ_LT_VERSION." >&2
	echo "Please get it at eg. http://www.gnu.org/software/libtool/." >&2
	exit 1
fi
LT_VERSION=`$LIBTOOL --version 2>/dev/null | sed -n '/^ltmain\.sh/{s/([^)]*)//g;s/ltmain.sh//g;s/ //g;p;q;}'`
_LT_VERSION=`echo $LT_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_REQ_LT_VERSION=`echo $REQ_LT_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`

if [ "$_LT_VERSION" -ge "$_REQ_LT_VERSION" ]; then
	echo "libtool $LT_VERSION is $REQ_LT_VERSION or newer. Good."
elif [ "$_LT_VERSION" -lt "$_REQ_LT_VERSION" ]; then
	echo "libtool $LT_VERSION is older than $REQ_LT_VERSION." >&2
	echo "We require (at least) libtool $REQ_LT_VERSION." >&2
	echo "Please get a newer version (cf. http://www.gnu.org/software/libtool/)." >&2
	exit 1
fi


REQ_PY_VERSION="2.0.0"
if [ ! "`type -p python`" ]; then
	echo "no python found." >&2
	echo "We require (at least) Python $REQ_PY_VERSION." >&2
	echo "Please get a newer version (cf. http://www.python.org/)." >&2
	exit 1
fi
PY_VERSION=`python -V 2>&1 | sed -n -e '/^[Pp]ython/{s/.* //g;s/-.*//g;p;q;}'`
_PY_VERSION=`echo $PY_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
_REQ_PY_VERSION=`echo $REQ_PY_VERSION | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`

if [ "$_PY_VERSION" -ge "$_REQ_PY_VERSION" ]; then
	echo "Python $PY_VERSION is $REQ_PY_VERSION or newer. Good."
elif [ "$_PY_VERSION" -lt "$_REQ_PY_VERSION" ]; then
	echo "Python $PY_VERSION is older than $REQ_PY_VERSION." >&2
	echo "We require (at least) Python $REQ_PY_VERSION." >&2
	echo "Please get a newer version (cf. http://www.python.org/)." >&2
	exit 1
fi


$AUTOGEN `pwd` $_AM_VERSION || exit 1

rm -f acconfig.h
cp configure.ag configure.in

echo "AC_OUTPUT(" >> configure.in
cat acout.in  >> configure.in
echo ")" >> configure.in


$LIBTOOLIZE -c -f || exit 1

# default deplibs_check_method (pass all libs)
# needed since deplibs is switched off in libtool 1.3c (we cannot wait for 1.4)
test -f conf/ltconfig && perl -i -p -e  's/&& deplibs_check_method=unknown/&& deplibs_check_method=pass_all/g' conf/ltconfig


# in case automake was installed after libtool:
# give aclocal a hint, where to find libtool.m4
LT_M4_DIR=""
d="`type -p $LIBTOOL | sed 's|/bin/'"$LIBTOOL"'$||'`/share/aclocal"
if [ -d "$d" ] ; then
	LT_M4_DIR="-I $d"
fi

# make sure, aclocal finds pkg.m4 even if pkg-config is not installed in /usr/;
# requires that location of pkg-config is in PATH
PKG_M4_DIR=""
d="`type -p pkg-config | sed 's|/bin/pkg-config$||'`/share/aclocal"
if [ -d "$d" ] ; then
	PKG_M4_DIR="-I $d"
fi

aclocal -I . -I conf $LT_M4_DIR $PKG_M4_DIR $CONFDIR || exit 1

if [ "$_AM_VERSION" -lt "$_TAR_AM_VERSION" ]; then
	# automake < 1.9 does not yet support option "tar-ustar";
	# hence, we omit it and rely on the patch below.
	perl -i -p -e 's|tar-ustar||' configure.in
fi
# in case we do / can not (yet) use AM_INIT_AUTOMAKE([tar-ustar]):
# patch aclocal.m4 to "de-force" Unix V7 tar format with `make dist`,
# since we do have filenames/-paths longer than 99 characters.
perl -i -p -e 's| chof | chf |g' aclocal.m4

# patch aclocal.m4 to call the linker with "-IPA" on IRIX (medusa)
# (just adding -IPA to LDFLAGS somehow doesn't help ...)
perl -i -p -e 's|(LD-ld. )|$1-IPA |g' aclocal.m4

# patch aclocal.m4 for cygpath on CYGWIN
grep '"$CYGPATH_W"' aclocal.m4 >/dev/null && cat << "EOF" | patch aclocal.m4
--- aclocal.m4.ORG      2004-09-07 18:32:18.593750000 +0200
+++ aclocal.m4  2004-09-07 18:34:05.453125000 +0200
@@ -6386,11 +6386,14 @@
 if test -z "$CYGPATH_W"; then
   if (cygpath --version) >/dev/null 2>/dev/null; then
     CYGPATH_W='cygpath -w'
+    CYGPATH_WP='cygpath -wp'
   else
     CYGPATH_W=echo
+    CYGPATH_WP=echo
   fi
 fi
 AC_SUBST([CYGPATH_W])
+AC_SUBST([CYGPATH_WP])
 
 # Define the identity of the package.
 dnl Distinguish between old-style and new-style calls.
EOF


autoheader || exit 1
automake --add-missing --copy --foreign || exit 1

#autoupdate || exit 1
autoconf || exit 1


exit 0
